---
title: A historical analysis of the evolution of active travel behaviour in Canada
author:
  - name: Alice Anonymous
    email: alice@example.com
    affiliation: Some Institute of Technology
    correspondingauthor: true
    footnote: 1
  - name: Bob Security
    email: bob@example.com
    affiliation: Some Institute of Technology
    footnote: 1
  - name: Cat Memes
    email: cat@example.com
    affiliation: Some Institute of Technology
address:
  - code: Some Institute of Technology
    organization: Big Wig University
    addressline: 1 main street
    city: Gotham
    state: State
    postcode: 123456
    country: United States
footnote:
  - code: 1
    text: "These authors contributed equally to this work."
abstract: |
    Impedance functions are used to represent travel behaviour due to their potential to capture traveler responses to geographic distance between origins and destinations. Focusing our analysis on active transportation (AT) modes in Canadian metropolitan regions, this study has as objectives to provide an historical overview of active mobility in terms of main origins, destinations and travel time of walking and cycling trips, and to identify appropriate impedance functions for AT modes considering a wide range of destinations and time periods. To achieve these objectives, this paper analyzed more than cases of 12,000 AT episodes, that represented more than 12 million episodes, from the Canadian General Social Survey (GSS) from 1992 to 2015. 
    This study confirmed that for walking trips, typical travel times remained constant at 10 minutes since 2005, while for cycling trips, typical travel times fluctuated, declining from 20 minutes in 1992 to 10 minutes in 2010 before increasing to 20 minutes in 2015. For walking trips, findings indicate that 'Home' continues to be the main hub, either as an origin or destination. For cycling trips, the combination of 'Home' and 'Work or school' accounted for most of the trips. Additionally, we fitted 64 impedance functions for twelve destinations and over 20 years. The results indicate that none of the parameterized functions were exponential, suggesting that the impedance functions commonly used in active accessibility studies may not accurately capture travel behavior, especially for very short trips, giving shorter trips a higher probability of being made. The estimated impedance functions can be employed in active accessibility analysis to help to reduce the dependence on private vehicles and promote healthier, more sustainable travel behaviour.

keywords: 
  - Active mobility
  - Walking
  - Cycling
  - Impedance function
  - Temporal evolution 
journal: "An awesome journal"
date: "`r Sys.Date()`"
linenumbers: true
numbersections: true
bibliography: mybibfile.bib
biblio-style: elsarticle-harv # author year style for natbib - use 'elsarticle-num' or 'elsarticle-num-names' for numbered scheme
classoption: preprint, 3p, authoryear # remove authoryear is not using `elsarticle-harv`
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output: 
  rticles::elsevier_article:
    keep_tex: true
    citation_package: natbib
---

```{r install-activeCA, include = FALSE}
# install.packages("pak")
# pak::pak("dias-bruno/ActiveCA")
opts <- options(knitr.kable.NA = "")

knitr::knit_hooks$set(inline = function(x) {
   if (is.numeric(x)) {
     format(x, big.mark = ",", scientific = FALSE)
   } else {
     x
   }
 })

rm(list=ls())
```

```{r load-packages, include=FALSE, cache=FALSE}
# Load packages
library(ActiveCA)
library(here)
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
library(reshape2)
library(rlang)
library(scales)
library(gridExtra)
library(ggpubr)
library(grid)
library(stats)
library(Hmisc)
library(stringr)
library(patchwork)
```

```{r load-data, include = FALSE}
# Load data
data(gss_impedances)
data(gss_episodes)
data(gss_main_1992)
data(gss_main_1998)
data(gss_main_2005)
data(gss_main_2010)
data(gss_main_2015)
data(gss_main_2022)
```

```{r renaming-destinations, echo=FALSE, cache=FALSE, include=FALSE}
# Filtering episodes and impedances functions 
gss_episodes <- gss_episodes %>%
  filter(YEAR > 1986)
  
gss_impedances <- gss_impedances %>%
  filter(YEAR > 1986)

# Renaming 'dest_label' and 'orig_label' values to reduce table space
gss_impedances_renamed <- gss_impedances %>%
  mutate(dest_label = case_when(
    dest_label == "Grocery store, other stores or mall" ~ "Grocery store",
    dest_label == "Restaurant, bar or club" ~ "Restaurant",
    dest_label == "Sports centre, field or arena" ~ "Sport area",
    dest_label == "Medical, dental or other health clinic" ~ "Health clinic",
    dest_label == "In the neighbourhood" ~ "Neighbourhood",
    dest_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ dest_label  # Keep all other values as they are
  ), 
  orig_label = case_when(
    orig_label == "Grocery store, other stores or mall" ~ "Grocery store",
    orig_label == "Restaurant, bar or club" ~ "Restaurant",
    orig_label == "Sports centre, field or arena" ~ "Sport area",
    orig_label == "Medical, dental or other health clinic" ~ "Health clinic",
    orig_label == "In the neighbourhood" ~ "Neighbourhood",
    orig_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ orig_label))

# Renaming 'dest_label' and 'orig_label' values to reduce table space
gss_episodes_renamed <- gss_episodes %>%
  mutate(dest_label = case_when(
    dest_label == "Grocery store, other stores or mall" ~ "Grocery store",
    dest_label == "Restaurant, bar or club" ~ "Restaurant",
    dest_label == "Sports centre, field or arena" ~ "Sport area",
    dest_label == "Medical, dental or other health clinic" ~ "Health clinic",
    dest_label == "In the neighbourhood" ~ "Neighbourhood",
    dest_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ dest_label  # Keep all other values as they are
  ), 
  orig_label = case_when(
    orig_label == "Grocery store, other stores or mall" ~ "Grocery store",
    orig_label == "Restaurant, bar or club" ~ "Restaurant",
    orig_label == "Sports centre, field or arena" ~ "Sport area",
    orig_label == "Medical, dental or other health clinic" ~ "Health clinic",
    orig_label == "In the neighbourhood" ~ "Neighbourhood",
    orig_label == "Library, museum or theatre" ~ "Cultural venues",
    TRUE ~ orig_label))
```

```{r main-episodes-junction, echo=FALSE, cache=FALSE, include=FALSE}
values_ordered <- c("15 to 24 years","25 to 34 years","35 to 44 years",
                    "45 to 54 years", "55 to 64 years","65 to 74 years",
                    "75 years and over")

# 1992
gss_main_1992_file <- gss_main_1992 %>%
  filter(DVCMA == 'CMA') %>% # Selecting only people living in CMA/CA
  dplyr::select(SEQNUM, FWGHT, DVSEX, DVAGEGR) %>%
  rename(PUMFID = SEQNUM, 
         WGHT_PER = FWGHT, 
         GENDER2 = DVSEX, 
         AGE = DVAGEGR) %>%
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "1992",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 1992, 
         AGE = case_when(
           AGE == "15 to 17 years" ~ "15 to 24 years",
           AGE == "18 to 19 years" ~ "15 to 24 years",
           AGE == "20 to 24 years" ~ "15 to 24 years",
           AGE == "25 to 29 years" ~ "25 to 34 years",
           AGE == "30 to 34 years" ~ "25 to 34 years",
           AGE == "35 to 39 year" ~ "35 to 44 years",
           AGE == "40 to 44 years" ~ "35 to 44 years",
           AGE == "45 to 49 years" ~ "45 to 54 years",
           AGE == "50 to 54 years" ~ "45 to 54 years",
           AGE == "55 to 59 year" ~ "55 to 64 years",
           AGE == "60 to 64 years" ~ "55 to 64 years",
           AGE == "65 to 69 years" ~ "65 to 74 years",
           AGE == "70 to 74 years" ~ "65 to 74 years",
           AGE == "75 to 79 year" ~ "75 years and over",
           AGE == "80 years and over" ~ "75 years and over"), 
           AGE = factor(AGE, levels = values_ordered, ordered = TRUE),
         GENDER2 = case_when(
           GENDER2 == "Male" ~ "Men+",
           GENDER2 == "Female" ~ "Women+"),
         GENDER2 = factor(GENDER2, levels = c("Men+", "Women+"), ordered = FALSE))

# 1998
gss_main_1998_file <- gss_main_1998 %>%
  filter(CMAPRV == 'CMA') %>% # Selecting only people living in CMA/CA
  dplyr::select(RECID, WGHTFIN, SEX, AGEGR10) %>%
  rename(PUMFID = RECID, 
         WGHT_PER = WGHTFIN, 
         GENDER2 = SEX, 
         AGE = AGEGR10) %>%
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "1998",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 1998, 
         AGE = case_when(
           AGE == "15 to 24 years" ~ "15 to 24 years",
           AGE == "25 to 34 years" ~ "25 to 34 years",
           AGE == "35 to 44 years" ~ "35 to 44 years",
           AGE == "45 to 54 years" ~ "45 to 54 years",
           AGE == "55 to 64 years" ~ "55 to 64 years",
           AGE == "65 to 74 years" ~ "65 to 74 years",
           AGE == "75 to 84 years" ~ "75 years and over",
           AGE == "85 years and over" ~ "75 years and over"), 
           AGE = factor(AGE, levels = values_ordered, ordered = TRUE),
         GENDER2 = case_when(
           GENDER2 == "Male" ~ "Men+",
           GENDER2 == "Female" ~ "Women+"),
         GENDER2 = factor(GENDER2, levels = c("Men+", "Women+"), ordered = FALSE))

# 2005
gss_main_2005_file <- gss_main_2005 %>% 
  filter(LUC_RST == "CMA/CA") %>% # Selecting only people living in CMA/CA
  dplyr::select(RECID, WGHT_PER, SEX, AGEGR10) %>%
  rename(PUMFID = RECID, 
         WGHT_PER = WGHT_PER, 
         AGE = AGEGR10,
         GENDER2 = SEX) %>%
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "2005",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 2005,
         GENDER2 = case_when(
           GENDER2 == "Male" ~ "Men+",
           GENDER2 == "Female" ~ "Women+"),
         GENDER2 = factor(GENDER2, levels = c("Men+", "Women+"), ordered = FALSE), 
           AGE = factor(AGE, levels = values_ordered, ordered = TRUE))

# 2010
gss_main_2010_file <- gss_main_2010 %>% 
  filter(LUC_RST == "CMA/CA") %>% # Selecting only people living in CMA/CA
  dplyr::select(RECID, WGHT_PER, SEX, AGEGR10) %>%
  rename(PUMFID = RECID, 
         WGHT_PER = WGHT_PER, 
         AGE = AGEGR10,
         GENDER2 = SEX) %>%
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "2010",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 2010,
         GENDER2 = case_when(
           GENDER2 == "Male" ~ "Men+",
           GENDER2 == "Female" ~ "Women+"),
         GENDER2 = factor(GENDER2, levels = c("Men+", "Women+"), ordered = FALSE), 
           AGE = factor(AGE, levels = values_ordered, ordered = TRUE))

# 2015
gss_main_2015_file <- gss_main_2015 %>% 
  filter(LUC_RST == "CMA/CA") %>% # Selecting only people living in CMA/CA
  dplyr::select(PUMFID, WGHT_PER, SEX, AGEGR10) %>%
  rename(AGE = AGEGR10, 
         GENDER2 = SEX) %>% 
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "2015",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 2015,
         GENDER2 = case_when(
           GENDER2 == "Male" ~ "Men+",
           GENDER2 == "Female" ~ "Women+"),
         GENDER2 = factor(GENDER2, levels = c("Men+", "Women+"), ordered = FALSE), 
           AGE = factor(AGE, levels = values_ordered, ordered = TRUE))

# 2022
gss_main_2022_file <- gss_main_2022 %>% 
  filter(LUC_RST == "Larger urban population centres (CMA/CA)") %>% # Selecting only people living in CMA/CA
  dplyr::select(PUMFID, WGHT_PER, GENDER2, AGEGR10) %>%
  rename(AGE = AGEGR10) %>% 
  mutate(dest_label = list(unique(
    gss_episodes_renamed[gss_episodes_renamed$YEAR == "2022",]$dest_label))) %>%
  unnest(dest_label) %>%
  mutate(YEAR = 2022)

# Creating a new file with all main files 
main_file <- rbind(gss_main_1992_file, gss_main_1998_file, gss_main_2005_file, 
                   gss_main_2010_file, gss_main_2015_file, gss_main_2022_file)

# Counting walking episodes 
act_walk <- gss_episodes_renamed %>% 
  filter(YEAR > 1986 & MODE == 'Walking') %>%
  group_by(PUMFID, YEAR, MODE, dest_label) %>% 
  summarise(Count = n(), Total_eps = sum(WGHT_EPI))

# Counting cycling episodes 
act_bike <- gss_episodes_renamed %>% 
  filter(YEAR > 1986 & MODE == 'Cycling') %>%
  group_by(PUMFID, YEAR, MODE, dest_label) %>% 
  summarise(Count = n(), Total_eps = sum(WGHT_EPI))

# Joining walking and cycling episodes
act_ep_counts <- rbind(act_bike, act_walk)

# Bring the counts of activity episodes to the person's file
main_act_eps <-  main_file %>%
  mutate(MODE = list(c("Walking", "Cycling"))) %>%
  unnest(MODE) %>%
  left_join(act_ep_counts, by = c("PUMFID", "YEAR", "MODE","dest_label")) %>%
  mutate(Count = replace_na(Count, 0), Total_eps = replace_na(Total_eps, 0))
```

# Introduction

The idea that travel behaviour can be influenced by city form has attracted growing interest in urban and transportation planning. Cities intent to encourage residents to adopt more sustainable modes of transportation, such as walking, cycling, and public transit, by developing environments that offer diverse transportation alternatives while simultaneaously improving accessibility - defined as the of reaching destinations and opportunities [@iacono2008access]. AT modes, including walking and cycling, play a important role in enhancing and promoting urban sustainability [@hino2014built; @lamiquiz2015effects], making them central to urban mobility research and policy-making [@handy1993regional; @clifton2001evaluating; @frank2001built; @krizek2005perspectives; @sallis2004active; @vandenbulcke2009mapping; @wu2019measuring]. Walking and cycling accessibility are closely related, jointly contributing to the concept of "active accessibility" or "non-motorized accessibility". when incorporated into urban and transportation planning, they help to reduce the dependence on private vehicles and promote healthier, more sustainable travel behaviour among residents.

There are two main components when measuring accessibility: the location and power of attraction of urban opportunities (trip benefit), and the barrier in travel from the origin to the destination (trip cost). A way for measuring the cost of travel when calculating accessibility is using impedance functions, a methods that is receiving attention from transportation planning scholars, urban geography, and sustainable development [@frank2005linking; @krizek2005perspectives; @currie2010quantifying; @iacono2010; @yang2012walking; @millward2013active; @nassir2016utility; @saghapour2017measuring; @wu2019measuring]. The impedance functions have different forms and all of them serve as a tool to understand the travel behaviour, since they work as measure of the willingness to travel a certain distance to achieve a desired destination, where a service or an opportunity is located [@taylor1975distance; @fotheringham1981spatial; @kwan1998space; @eldridge1991warped; @luoma1993threshold; @papa2012gravity; @yang2012walking; @millward2013active; @vale2017influence]. In this concept, areas with higher accessibility are those characterized by a lower impedance when traveling to desirable destinations. In relation to active accessibility, increasing the distance between two points generally implies in a probability decrease of that trip being done by walking or biking [@hansen1959accessibility; @pirie1979measuring; @handy1997measuring; @geurs2001accessibility; @bhat2002development; @church2003measuring; @kwan2003recent; @geurs2004; @levinson2005access; @cascetta2013new]. However, more information about the willingness of some individuals to walk or cycle greater distance is needed, as well as more data on how distance affects the type and feasibility of the activity, destinations desirability, and the characteristics of those embarking on the trip in different situations. In this context, investigate the evolution and dynamics of impedance function over time becomes important, since they are easily impacted by changes in the transportation network or in urban spatial configurations [@iacono2008access; @iacono2010]. Luoma, Mikkonen, and Palomaki [-@luoma1993threshold] evidenced a decreasing in the distance decay parameter over time in the province of Vaasa, Finland, attributing this trend to improvements and maturation of the transportation system [@luoma1993threshold]. A few years later, Mikkonen and Luoma [-@mikkonen1999parameters] argued that this difference was mainly caused by the establishment of new big retail store units, elucidating the factors behind these temporal patterns in the gravity models patterns [@mikkonen1999parameters].

Since the beginning applications of the gravity-accessibility models, a range of impedance functions have been applied to describe the distribution of walking and cycling trips, wether for general or specific purposes [@iacono2008access; @iacono2010; @larsen2010beyond; @yang2012walking; @millward2013active; @vale2017influence; @li2020approach]. Selecting an appropriate impedance function can be challenging and results in a diverse range of cost decay functions that are employed as impedance functions in accessibility measures, including *threshold functions* (e.g., binary Step Function and multiple Step Function) and *smooth cost decay functions* (e.g., log-normal, normal, gamma, and exponential function) [@de2009exponential; @reggiani2011accessibility; @osth2016new; @itf2017linking]. The variety of functions relies in how scholars approach the influence of distance, with negative exponential distance-decay functions are commonly used in assessing non-motorized accessibility, capturing the willingness of individuals to walk or cycle to destinations [@handy1997measuring; @geurs2001accessibility; @iacono2010; @vega2012using; @millward2013active; @vale2017influence; @li2020approach].

The merit of negative exponential function is due to its ability to assign decreasing influences to more remote opportunities, giving a more accurate estimate for shorter trips [@iacono2010; @kanafani1983transportation; @fotheringham1989spatial]. However, in addition to determine the form of the impedance function, scholars also need to specify the variable used to measure impedance, which can be either time, distance, monetary cost, a combination these last variables or even a generalized cost concept. Among these options, the choice between time and distance as the impedance has been found to be most used based on previous studies [@iacono2010; @hull2012accessibility; @sun2012measuring; @lowry2012using; @vasconcelos2012evaluation], with distance being more adopted in non-motorized applications since extracting accurate travel times from existing network models can be challenging [@handy1997measuring; @iacono2010; @yang2012walking; @arranz2019measuring]. Additionally, estimate impedance function to AT modes requires appropriate travel survey data that captures pedestrian and cycle behaviour, resulting in researchers recurring to retrospective questionnaires to assess subjective aspects such as the frequency and duration of walking and cycling activities. Notably, regional household travel surveys that include trips made by non-motorized modes have been employed for this purpose [@iacono2010; @millward2013active]. In opposition to these specific surveys, some data sets provides a nationwide perspective, including travel for different purposes and detailing the trip with valuable information, named episodes, regarding the origins, destinations, and time-based lengths. Besides this type of data can provides a deeper comprehension about the AT behaviour, only few studies have examined travel behaviour nationally.

Having presented this context, this paper poses the questions: What is the typical travel time for AT modes (walking and cycling) in Canadian metropolitan regions, considering various destinations and years? What is the evolution of the prevalence of AT episodes in the Canadian population? Which impedance functions best represent AT travel behavior? To answer the research questions, this study has as two main objectives: first, to provide an overview of the AT in terms of main origins, destinations, travel time, and active population (stratified by age group and sex); and second, to identify appropriate impedance functions for AT modes for different destinations and time periods in Canadian metropolitan areas.

To achieve both objectives, we utilize data provided by the `ActiveCA` R package [@dossantos2024ActiveCA], an open data product in the form of an R data package with information about active travel in Canada. This data product is based on Public Use Microdata Files of Statistics Canada's General Social Survey (GSS) program with a focus on the Time Use Survey cycles. To build this package, the authors extracted all walking and cycling episodes and their corresponding episode weights for GSS cycles, Cycles 7 (1992), 12 (1998), 19 (2005), 24 (2010), and 29 (2015), spanning a period of almost thirty years. Origins and destinations were categorized, enabling the investigation of active travel for broad destination categories and purposes.

We recognize that non-work travel encompasses a range of trip purposes and diverse traveler behaviors, which makes impedance functions essential analytical tools for studying non-work accessibility. Grengs [-@grengs2015nonwork] emphasizes the importance of elaborating distinct functions for each travel purpose, a principle that guides this analysis. Our investigation covers a variety of trip purposes, ranging from commutes to homes, workplaces, or educational institutions to social visits, outdoor activities, business trips, shopping, cultural outings to libraries, museums, or theaters, dining out, and engaging in religious practices. Our research aims to enhance the current knowledge about active travel behaviour and provide empirical data about frequency and duration of typical pedestrian and cycling trips for different purposes, by applying the methodology on a nationally representative samples of Canadian residents. Lastly, this analysis seeks to contribute to the ongoing conversation on AT, highlighting its role in influencing transportation plans to a more sustainable alternative.

# Background

Accessibility is the main benefit provided by the transportation system [@pereira2017], being understood as the potential to access spatially distributed opportunities [@hansen1959accessibility; @paez2012]. When computing accessibility measure, is necessary take into account the challenges associated with this access to different locations and opportunities. Usually, the effect of travel costs is expressed by "impedance functions", also called "distance decay functions" [@hansen1959accessibility; @koenig1980indicators; @fotheringham1981spatial].

Overall, impedance functions are derived from estimates based on distributions of sample data that reflect variations in the willingness of individuals to travel different distances to reach opportunities [@hsiao1997use; @zhao2003forecasting; @iacono2010; @li2020approach]. Their main objective is to describe the decrease in the intensity of interaction as the cost of travel between locations increases. The cost of travel is usually measured in terms of the distance between the places of origin and destination, or in terms of the time spent reaching the destination from the point of origin.

In fact, distant facilities are less likely to be used compared to closer ones [@hansen1959accessibility; @koenig1980indicators; @fotheringham1981spatial; @skov2001estimation]. Thus, the "distance decay" effect suggests that adding a unit of distance to a long trip is less significant than adding a unit to a shorter trip [@carrothers1956historical], since the farther location already has a lower probability of access for the person willing to travel.

Examining the impedance functions across different modes of transport and destinations is a good way to understand the travel behavior associated with each mode, while also helping to examine allegations about travel behavior. Current interest in creating "livable" communities often relies on broad assumptions about individuals' willingness to walk or bike to different destinations. For example, it is commonly assumed that people are generally willing to walk up to a quarter mile to access most places [@untermann1984accommodating]. Similarly, the recent "15-minute city" concept proposes that the majority of daily necessities should be accessible by walking or cycling within 15 minutes [@moreno2021].

## Impedance functions in accessibility measures

Since the research of Hansen [-@hansen1959accessibility], different categories of accessibility measures have been developed, such as indicators based on actives, infrastructure, individuals and utilities [@geurs2004; @paez2012]. The family of gravity-based accessibility have been widely used in active modes [@miller2005place]. Many gravity-based accessibility measures derive from the work of Hansen [-@hansen1959accessibility], represented in (Equation \ref{eq:accessibility-equation}), in which an impedance function weights opportunities:

\begin{equation}
A_{i} = \sum_{j=1}^J O_j .f(c_{ij})
\label{eq:accessibility-equation}
\end{equation}

The accessibility score $A_{i}$ at each origin $i$ is obtained by summing up the opportunities $O$ available at destination $j$, where $i$ and $j$ are sets of spatial units in a region. However, the number of opportunities in each destination is gradually discounted as travel costs become higher and the the rate at which this weight decreases is determined by a decay function. $f(c_{ij})$ represents the impedance during the trip from origin $i$ to destination $j$ and $c_{ij}$ reflects the generalized travel cost, potentially encompassing factors such as time, distance and effort. In this way, the impedance function $f(c_{ij})$ allows the accessibility analyst to define a measure of travel behavior with precision: the relationship between the "population" at an origin and where they normally want to or can go to reach "opportunities" at destinations. The definition of the impedance function $f(c_{ij})$ is very important from this perspective.

Another type of family of accessibility measures are *cumulative opportunity* metrics, commonly referred to as isochronous indices. The binary function Equation (\ref{eq:cumulative-equation}) forms the basis of the cumulative opportunities maeasure approach. This function determine accessibility by summing up the number of opportunities available within a specific limiar of travel time or distance from a reference point, without discounting the potential of the trip in relation to the associated cost. They use a rectangular function, categorizing the trip as "acceptable" within certain limits and "unacceptable" beyond them. One of the main complexities of these metrics is deciding what the appropriate limiar point is. This decision may be based on the prevailing mobility patterns of the population or may reflect established norms, conventions or informed projections of the researcher. Note that the cumulative opportunity measure can be understood as a special case of a gravity-based measure in which the weight of each opportunity is defined by a binary function, rather than a gradually decaying function [@pereira2023].

\begin{equation}
C_{ij} =
\begin{cases}
  1 & \text{if } c_{ij} \le x \\
  0 & otherwise
\end{cases}
\label{eq:cumulative-equation}
\end{equation}

Among the various mathematical forms that can represent impedance functions, the negative exponential function is the dominant choice in accessibility research [@meyer1984urban; @gutierrez1996european; @kwan1998space; @apparicio2008comparing; @iacono2008access; @iacono2010; @larsen2010beyond; @millward2013active]. Its high adoption can be attributed mainly to its ability to give greater weight to nearby opportunities, and greater weight to distant opportunities - a highly relevant characteristic for active modes of transportation, such as walking and cycling. When Hansen [-@hansen1959accessibility] introduced their accessibility measure, the author applied and indicated the use of exponential distributions $(e ^ {-\beta x})$ as the impedance function. After this, several other studies [@fotheringham1989spatial; @de2009exponential; @iacono2010; @signorino2011gravity; @prins2014many] use the negative exponential function after comparison with empirical trip distribution data.

Researchers can adopt other forms of impedance functions when calculating the distance decay effect in accessibility analysis. One of these options is to adopt a probability density function (PDF) [@soukhov2024]. Using a PDF, $f()$ can be interpreted as the probability density of a trip occurring for each value of travel cost $c_{ij}$. If a graph of the PDF (y-axis) is plotted against the travel cost $c_{ij}$ (x-axis), the probability of a trip occurring between a given range of $c_{ij}$ is the area under the curve. In this case, the total area under the PDF curve always sums to 1, meaning that there is 100% probability that the trip will occur between the minimum and maximum $c_{ij}$.

Dunn et al. [-@dunn2023] presented a set of distributions that serve as PDFs. From their survey, we selected some options for $f()$ commonly used in accessibility research and their impact on the number of opportunities (the sum of opportunities) at specific travel costs $c_{ij}$, namely: uniform, negative exponential, gamma, normal, and lognormal distributions.

-   **Uniform distribution**

The uniform distribution or rectangular PDF looks very similar to the binary function, since it only returns one of two values, but ensure that area under the curve for the range of $c_{ij}$ is 1. The uniform distribution PDF is shown in (Equation \ref{eq:uniform-equation}).

\begin{equation}
f(c_{ij})^{uniform} =
\begin{cases}
  \frac{1}{c_{max} - c_{min}} & \text{for } c_{min} \le c_{ij} \le c_{max} \\
  0 & \text{otherwise}
\end{cases}
\label{eq:uniform-equation}
\end{equation}

The parameters to be calculated are $c_{max}$ and $c_{min}$, which represent the maximum and minimum travel costs that describe the observed or assumed willingness to reach destinations. In this distribution, all values within the interval are equally likely, and all values outside the interval have probability 0, assuming that the population's potential to interact with these opportunities is zero. Usually, $c_{min}$ has value 0.

-   **Exponential distribution**

The exponential distribution PDF equation is given by Equation (\ref{eq:exponential-equation}). This model suggests that impedance decreases exponentially with increasing cost $(c_{ij})$. The parameter $\beta$ represents the decay rate, with higher values indicating a faster decrease in accessibility with increasing cost. As already mentioned, this function is widely used due to its simplicity and ability to model the rapid drop-off in accessibility over distance.

\begin{equation}
f(c_{ij}) = e^{-\beta c_{ij}} \text{ with } c_{ij} \ge 0
\label{eq:exponential-equation}
\end{equation}

-   **Gamma distribution**

The gamma distribution PDF equation is presented by the Equation \ref{eq:gamma-equation}.

\begin{equation}
f(c_{ij}) = 
   \begin{cases}
\frac{1}{\sigma^\alpha\Gamma(\alpha)} c_{ij}^{\alpha-1} e^{\frac{-c_{ij}}{\sigma}} & \text{if } 0 \leq c_{ij} <      \infty  \text{ and } \alpha, \sigma > 0 \\ 0 & \text{otherwise}
   \end{cases}
\label{eq:gamma-equation}
\end{equation}

Where $\Gamma(\alpha)$ is the gamma function to be estimated. In this case, the probability is typically low at low cost, higher at medium cost, and low again at high cost. The higher the $\sigma$ (scale rate) parameter, the higher the probability that the majority of trips will be in the low cost range. So at low values of the $\sigma$ (scale rate) parameter, the same probability is spread over a wider range of travel costs. For the $\alpha$ (shape) parameter, the higher the value, the higher the probability density of trips with a higher average cost [@soukhov2024].

-   **Lognormal distribution**

The normal distribution, also often called the Gaussian distribution, is suitable when the travel cost is found to be distributed normally. The normal distribution has the PDF form displayed in Equation (\ref{eq:normal-equation}).

\begin{equation}
f(c_{ij}) = \frac{1}{\sqrt{2\pi} \sigma c_{ij}} e^{-\frac{(\ln c_{ij} - \mu)^2}{2\sigma^2}}
\label{eq:normal-equation}
\end{equation}

In this equation, $\mu$ and $\sigma$ are the mean and standard deviation of the distribution and need to be estimated together to control the shape of the normal curve. In this distribution, about 68% of the observations will fall within 1 standard deviation of the mean, about 95% will fall within 2 standard deviations, and about 99.7% will fall within 3 standard deviations of the mean. In this case, the values close to the mean will have the highest probability.

-   **Lognormal distribution**

In many cases, the logarithm of the travel cost is found to be distributed normally. The lognormal distribution has the PDF form displayed in Equation (\ref{eq:lognormal-equation}).

\begin{equation}
f(c_{ij}) = \frac{1}{\sqrt{2\pi} \sigma c_{ij}} e^{-\frac{(\ln c_{ij} - \mu)^2}{2\sigma^2}}
\label{eq:lognormal-equation}
\end{equation}

It this equation, $\mu$ and $\sigma$ are the mean and standard deviation of the logarithm, and need to be estimated for together control the shape of the log-normal curve. Similar to the gamma function, the probability is typically low at low cost, higher at medium cost, and low again at high cost.

As the complexity of the PDF increases, so does the flexibility to explain travel behaviour. However, the estimation of the impedance function parameters needs to be calibrated if the accessibility estimates are to be representative of people's travel behaviour. This requires additional travel behaviour data to be used in the calibration process. In our case, we will use the `ActiveCA` package [@dossantos2024ActiveCA] to obtain the impedance functions, as the package contains ready-to-use data from GSS cycles.

## The GSS survey

The GSS provides a comprehensive cross-sectional snapshot of the Canadian population through telephone surveys established in 1985 [@statisticscanada2022]. The survey coverage area includes both metropolitan and non-metropolitan regions, ensuring a diverse and representative sample of the Canadian population. Specifically, the seven provinces and three territories of Canada were divided into distinct geographic strata for sampling purposes. Many Census Metropolitan Areas (CMAs), such as St. John's, Halifax, Saint John, Montreal, Quebec City, Toronto, Ottawa, Hamilton, Winnipeg, Regina, Saskatoon, Calgary, Edmonton, and Vancouver, were treated as separate strata. Additional strata were formed by grouping other CMAs within Quebec, Ontario, and British Columbia, and by categorizing non-CMA areas within each province into their own strata.

These surveys encompass an array of socio-demographic inquiries combined with questions concentrating on specific core themes, such as health, time use, and aspects like social support and aging. One of the standout features of the GSS is its recurring "time use" cycle [@statisticscanada2022], which concentrates in the daily activities of Canadians. This cycle captures the amount of time individuals allocate to various tasks and the sequence, location, and concurrent activities, offering a wide view of Canadians' daily lives. The questions within this cycle have been adapted and refined over the years to reflect the changing dynamics of daily life, ensuring that the data remains pertinent and contemporary.

# Materials and Methods

To investigate the historical active travel behavior in Canada, we analyzed five GSS Time Use cycles: Cycles 7 (1992), 12 (1998), 19 (2005), 24 (2010), 29 (2015) and 37 (2022). We excluded Cycle 2 (1986) from our analysis because this survey did not specify whether the respondent lived in a metropolitan area and did not present cycling as a option of transportation mode, although this cycle is notable for having been the first national random sample to examine Canadian time-use patterns. This paper is a direct application of the ready-to-use data set provided by the `ActiveCA` data package [-@dossantos2024ActiveCA], which is based on the Main and Episode files from the GSS Public Use Microdata Files. The Main file contains questionnaire responses and associated data from participants, while the Episode files provided detailed information about every activity episode reported by the respondents.

The methodology involves two main steps. The first step employs descriptive analysis of AT episodes to identify typical travel times across destinations and years, comparing their temporal evolution and identifying differences in AT episodes through statistical tests, and assess the active population in terms of sex and age group. The second step calculates and analyzes impedance functions for each combination of cycle, destination, and AT mode.

To facilitate collaboration and further analysis, we updated the `ActiveCA` R Package to include the methodology to obtain impedance functions from the raw data files (GSS surveys). Additionally, we created this paper using literate programming in which the R markdown code to fully reproduce this article is available on our GitHub repository *(include after the review)*, in line with the best practices of spatial data science [@arribas-bel2021; @paez2021]. These contributions improve our understanding of active travel behaviour in Canada and provide a basis for future research and policy-making.

## Analyzing active travel episodes

For each selected cycle of the GSS surveys, we reviewed the episode files to identify cases with activities listed as walking or cycling, selecting the locations immediately before and after the mobility episode. With this process, we were able to identify the origin and the destination of the active travel episode. We labeled the code variables with their appropriate descriptions, identifying the transportation mode, activity/reason of the travel, as well the province and urban classification of the respondent's residency (if the respondent lives in a CMA or in a Census Agglomerations).

Additionally, it was necessary to guarantee the data consistency across the surveys, since they have employed a variety of variable coding schemes. The range of activities and destinations considered in the surveys changed from 1992 to 2022. In 1992, there were only three options of origin/destination location available to the respondent: their home, other's home and work or study. In its turn, the most recent survey (2022) counts with twelve possible destination, including sport area (sports centre, field or arena), restaurant (including bar and club), health clinics (medical, dental or other health clinic), grocery stores (including other types of stores and malls) and more. In order to achieve uniformity, the activity categories from 2005, 2010, 2015, and 2022 were synchronised, and a similar process was employed for those from 1992 and 1998. For the preceding years (1992, and 1998), the trip origins and destinations were classified as "Home," "Other's home," and "Work or school." In the subsequent years (2005, 2010, 2015, and 2022), these categories were expanded to include "Business," "Restaurant" "Place of worship," "Grocery store" "Neighbourhood," "Outdoors," "Cultural venues" (such as library, museum and theatre), and "Sport area." This evolution in data collection reflects a growing understanding of the complex nature of urban mobility and the diverse purposes that motivate walking and cycling trips, providing a comprehensive foundation for analyzing distance decay and its implications for urban planning and sustainable transportation strategies.

Statistical analysis was used to characterize active travel episodes using cross-tabulations and graphs. Summary statistics and visualization techniques, including median values as a measure of typical value and boxplots, were employed to describe active travel across years, destinations, and transportation modes. To assess the statistical significance of potential temporal differences in the empirical episode data set for each destination, we applied the Kruskal-Wallis test. This test was chosen because it does not assume a normal distribution for the data, an important consideration since we made no assumptions about the distribution of the empirical data. The identification of impedance functions serves as the step that captures the distributional characteristics of the empirical values. The Kruskal-Wallis test evaluates differences in the medians of the empirical data.

## Analyzing the population with active travel records

After assessing the active travel episodes, we analyzed the population with records of active travel for each year of the analysis, stratifying the analysis by gender and age group. To stratify by gender, we adopted the definition used in the most recent GSS survey (2022), which was the first in the series to consider gender - recognizing a broader spectrum of gender identities - instead of biological sex, which had previously been limited to female and male categories. In the 2022 survey, due to the small size of the non-binary population, data aggregation was necessary to protect the confidentiality of respondents ([@statisticscanada2025]). As a result, information from the Time Use Survey 2022 is disseminated using a two-category gender variable. In this framework, individuals identifying as non-binary are distributed across the two other gender categories and are denoted by the "+" symbol. The category "Men+" includes men (and/or boys) as well as some non-binary persons, and the category "Women+" includes women (and/or girls) as well as some non-binary persons.

We recognize that biological sex does not always align with gender identity. However, to enable comparison across survey years, we assumed that individuals recorded as "female" in earlier surveys correspond to "Women+", and those recorded as "male" correspond to "Men+". We acknowledge that this approach does not fully capture gender diversity, particularly for trans and non-binary individuals, due to limitations in how gender was recorded in earlier surveys.

We also stratified the analysis by age group. To ensure the consistency across all survey years, we defined the following cohorts: "15 to 24 years", "25 to 34 years", "35 to 44 years", "45 to 54 years", "55 to 64 years", "65 to 74 years", and "75 years and over".

After defining the gender and age group categories, we identified the population with and without at least one active travel episode, considering both modes (walking and cycling). To complete the population analysis, we measured and examined the temporal evolution of the number of active trips per person for each survey year, considering both the active population and the general population. We also analyzed the number of walking episodes per person who reported walking activity, and the number of cycling episodes per cyclist, to identify possible trends within each AT mode. Finally, we compared the average duration of active travel episodes to observe changes over time.

## Estimating impedance function parameters

```{r echo=FALSE, cache=FALSE, include=FALSE}
less_than100 <- gss_episodes %>% 
  filter(DURATION > 100 & YEAR > 1986) %>%
  summarise(total_eps = n(),
            total_WGHT_EPI = sum(WGHT_EPI, na.rm = TRUE))


all_episodes <- gss_episodes %>% 
  filter(YEAR > 1986) %>%
  summarise(total_eps = n(),
            total_WGHT_EPI = sum(WGHT_EPI, na.rm = TRUE))
  
```

We applied the `fitdistrplus` package [@delignette2015fitdistrplus] to calculate the best PDF for every destination, mode of transportation and survey year, between the options: uniform, negative exponential, gamma, normal, and lognormal distributions. In order to calculate the impedance functions, two filters were applied in the GSS data set. The first is that we excluded all trips with travel times higher than 100 minutes (1.5 hours). An exploratory data analysis showed that, taking into account all the walking and cycling episodes (`r all_episodes$total_eps` in total), less than `r round(less_than100$total_eps/all_episodes$total_eps * 100, 2)`% of the episodes have a trip duration higher than this limit. When considering the weights of this episodes, travel times higher than 100 minutes represented `r round(less_than100$total_WGHT_EPI /all_episodes$total_WGHT_EPI * 100, 2)`% of the episodes.

It was also possible to know that trips with a duration higher than 100 minutes are mainly composed of hiking and camping episodes. The second filter was realized to select only the population living in a larger urban population centre. We decided to apply this restriction because the travel behaviour of residents of CMA and CA areas tends to be very different from those outside these large urban centres in terms of active travel.

# Results and discusion

## Descriptive analysis

### Walking and cycling episodes

```{r bulding table-01, echo=FALSE, cache=FALSE, include=FALSE}
max_duration <- 100

gss_impedances_renamed <- gss_impedances_renamed %>% 
  filter(DURATION <= max_duration & 
           DURATION > 0 & 
           YEAR > 1986 & 
           Pop_centre %in% c("CMA/CA", "CMA")) %>%
  mutate(WGHT_EPI = ifelse(is.na(WGHT_EPI), 1, WGHT_EPI)) 

gss_summary <- gss_impedances_renamed %>%
     group_by(YEAR, MODE) %>%
     dplyr::summarise(
         count = sum(WGHT_EPI),
         .groups = "drop") %>%
  rename(Mode = MODE) %>%
  pivot_wider(names_from = YEAR, values_from = count) %>% 
  mutate(Total = rowSums(across(where(is.numeric)), na.rm = TRUE))

gss_summary <- bind_rows(
  gss_summary,
  gss_summary %>%
    dplyr::summarise(across(where(is.numeric), \(x) sum(x, na.rm = TRUE))) %>%  
    mutate(Mode = "Total")
) 

gss_summary <- gss_summary %>% 
  mutate(
    `1992 (%)` = round(`1992` / gss_summary$`1992`[Mode == "Total"] * 100, 2),
    `1998 (%)` = round(`1998` / gss_summary$`1998`[Mode == "Total"] * 100, 2),
    `2005 (%)` = round(`2005` / gss_summary$`2005`[Mode == "Total"] * 100, 2),
    `2010 (%)` = round(`2010` / gss_summary$`2010`[Mode == "Total"] * 100, 2),
    `2015 (%)` = round(`2015` / gss_summary$`2015`[Mode == "Total"] * 100, 2),
    `2022 (%)` = round(`2022` / gss_summary$`2022`[Mode == "Total"] * 100, 2),
    `Total (%)` = round(`Total` / gss_summary$`Total`[Mode == "Total"] * 100, 2)
  ) %>%
  ungroup() %>%
  select("Mode", "1992", "1992 (%)", "1998", "1998 (%)", 
         "2005", "2005 (%)", "2010", "2010 (%)", "2015", "2015 (%)",
         "2022", "2022 (%)",
         "Total", "Total (%)") 

gss_summary[gss_summary$Mode == 'Total', ]$"1992 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"1992"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)

gss_summary[gss_summary$Mode == 'Total', ]$"1998 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"1998"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)

gss_summary[gss_summary$Mode == 'Total', ]$"2005 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"2005"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)

gss_summary[gss_summary$Mode == 'Total', ]$"2010 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"2010"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)

gss_summary[gss_summary$Mode == 'Total', ]$"2015 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"2015"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)

gss_summary[gss_summary$Mode == 'Total', ]$"2022 (%)" <- round(gss_summary[gss_summary$Mode == 'Total', ]$"2022"/gss_summary[gss_summary$Mode == 'Total', ]$"Total" *100, 2)


gss_totals_table <- gss_summary %>%
  kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
        caption = "\\label{tab:episodes-count-percentages}Weighted number of episodes identified in each active transportation mode by year", align = NULL, 
    col.names = c("Mode","","(%)","","(%)","","(%)","","(%)","","(%)","","(%)","","(%)")) %>% 
  kable_styling(full_width = FALSE, font_size = 6) %>%
  add_header_above(c(" " = 1, "1992" = 2, "1998" = 2, "2005" = 2, "2010" = 2, "2015"=2, "2022"=2, "Total" = 2))
```

After applying the filters to the GSS surveys, we obtained a total of 19,166 cases of active travel episodes. However, GSS surveys apply a probability sampling methodology, in which each episode or person selected in the sample represents several other episodes or persons not in the sample. The number of episodes and persons represented by a episode or person is determined by the weight or weighting factor. Because of this, every estimates of the number of episodes or persons need to be calculated applying the corresponding weighting factors.

Considering the weights - and from this point onward, all counts estimates presented in this paper account for them - the 19,166 episodes represent a total of `r format(gss_summary[gss_summary$Mode == 'Total',]$Total, big.mark = ",", scientific = FALSE)` episodes. Table \ref{tab:episodes-count-percentages} contains the weighted number of episodes about walking and cycling trips between 1992 and 2022, obtained from the GSS cycles. The year 2010 is the year with the most episodes, with `r gss_summary[gss_summary$Mode == 'Total',]$'2010'` episodes (representing `r gss_summary[gss_summary$Mode == 'Total',]$'2010 (%)'`% of the total). The year 2010 is followed by 2005 with `r gss_summary[gss_summary$Mode == 'Total',]$'2005'`, representing approximately `r gss_summary[gss_summary$Mode == 'Total',]$'2005 (%)'`% of all active travel episodes; followed by 2015 (`r gss_summary[gss_summary$Mode == 'Total',]$'2015'` episodes, `r gss_summary[gss_summary$Mode == 'Total',]$'2015 (%)'`% of the total), 2022 (`r gss_summary[gss_summary$Mode == 'Total',]$'2022'` episodes, `r gss_summary[gss_summary$Mode == 'Total',]$'2022 (%)'`% of the total), 1998 `r gss_summary[gss_summary$Mode == 'Total',]$'1998'` episodes, (`r gss_summary[gss_summary$Mode == 'Total',]$'1998 (%)'`% of the total), and 1992, with only `r gss_summary[gss_summary$Mode == 'Total',]$'1992'` episodes, representing `r gss_summary[gss_summary$Mode == 'Total',]$'1992 (%)'`% of the total.

When analyzing the two AT modes, walking episodes account for `r gss_summary[gss_summary$Mode == 'Walking',]$'Total (%)'`%, while the remaining `r gss_summary[gss_summary$Mode == 'Cycling',]$'Total (%)'`% are cycling episodes. The most recent survey (2022) showed that cycling trips accounted for almost 10% of active travel episodes, reinforcing an increasing trend in the cycling participation since 2005 - the year that marked the lowest representation, as opposed to 1992, when bicycle episodes marked the highest participation in all years (13%).

```{=html}
<!-- 
Unfortunately is too much work to obtain all the values automatically.
start -->
```

```{r table-01, echo=FALSE, cache=FALSE}
gss_totals_table
```

The maximum time spent on walking trips varied between 90 and 100 minutes across the years (\ref{tab:table-02}) - it is important to remember that trips with duration greater than 100 minutes were excluded from the analysis. The mean walking time also varies, starting at 20 minutes in 1992, dropping to 12 minutes between 1992 to 2005, and increasing again to 13 minutes in 2010, to 16 minutes in 2015, and to 18 minutes in 2022. However, it is known that the mean is a statistic that is highly influenced by extreme values. For this reason, we analyze the median travel time, as it is more representative of the typical travel time. The median time spent walking was 10 minutes in 1992, dropped to 5 minutes in 1998, remained constant at 10 minutes from 2005 to 2015, and increased to the highest level in 2022, to 15 minutes.

```{r table-02, echo=FALSE, cache=FALSE}
# Calculate min, mean, and max statistic (duration)
stats_data <- gss_impedances_renamed %>%
  group_by(YEAR, MODE) %>%
  dplyr::summarise(
    min = min(DURATION),
    mean = sum(DURATION * WGHT_EPI)/sum(WGHT_EPI),
    median =  Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    std = sd(DURATION),
    .groups = "drop"
  ) %>%
  pivot_longer(cols = c(min, mean, median, max, std), names_to = "Statistic", values_to = "Value") %>%
  pivot_wider(names_from = YEAR, values_from = Value)

# Combine counts and stats into one data frame
stats_data <- stats_data %>%
  mutate(MODE = factor(MODE, levels = c("Walking", "Cycling"))) %>%
  arrange(MODE, Statistic) %>%
  mutate(across(where(is.numeric), ~ round(.x, 0)))

# Rename the 'MODE' column to 'Mode' before generating the table
stats_data <- stats_data %>%
  rename(Mode = MODE) %>%
  dplyr::select(Mode, Statistic, everything()) %>% 
   mutate(Statistic = case_when(
    Statistic == "max" ~ "Maximum",
    Statistic == "min" ~ "Minimum",
    Statistic == "mean" ~ "Mean",
    Statistic == "median" ~ "Median",
    Statistic == "std" ~ "Standard deviation",
    TRUE ~ Statistic  # Keep all other values as they are
  ))
  

# Creating a latex table
styled_table_02 <- stats_data %>%
  kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
        caption = "\\label{tab:table-02}Descriptive statistics for episodes with active transport records",  
        align = c('l', 'l', rep('c', ncol(stats_data) - 2))) %>%
  kable_styling(full_width = FALSE, font_size = 8) %>%
  column_spec(1, bold = TRUE) %>%
  add_header_above(c(" " = 2, "Year" = ncol(stats_data) - 2)) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major")

# Print the table
styled_table_02
```

For cycling trips, the maximum travel time ranges from 60 to 100 minutes. Until 2022, maximum travel times had a similar pattern to walking trips, but the new survey showed that the maximum travel time for cycling trips was the lowest when considering all years for both modes (walking and cycling). The average cycling travel time varied considerably, ranging from 18 minutes in 2010 to 30 minutes in 2022. When we analyze the median travel time, we see that the typical cycling travel time also fluctuated between the periods, starting at 20 minutes in 1992 and peaking at 30 minutes in 2022. As was also the case with the walking travel times, these results show a trend of increasing for cycling trip duration throughout the years. The analysis of travel time statistics alone does not fully explain the reasons behind these fluctuations in travel time over the years. However, it is likely that these variations reflect changes in bicycle technology or cyclist behavior.

Figure \ref{fig:figure-destmodeyearperc} shows the percentage of each destination by year and by mode of transport. For all the years analyzed, 'Home' is the most common travel destination, regardless of whether the mode of transport considered is walking or cycling, with levels above 40%. After that, 'Work or school' appears as the second most common destination, especially for journeys by bicycle, with a peak of almost 36% of trips by bicycle in 1998, followed by a high drop to 23% in 2005. Along with the two destinations already mentioned, 'Other's home' is the only other destination present in the GSS surveys since 1992. This last destination seems to be a destination with a higher share when it comes to walking trips, but for both modes of transportation it seems that respondents are going less and less to other people's homes - a fact that can be explained by new communication technologies, in which a person does not need to visit another person's home to keep in touch with them.

```{r destinations-percentual, echo=FALSE, cache=FALSE, include=FALSE}
# summarizing episodes by mode, year and destination
# main_act_eps_summary <- main_act_eps %>%
#    group_by(Count, MODE, YEAR, dest_label) %>%
#    summarise(WGHT_PER_SUM = sum(WGHT_PER, na.rm = TRUE), .groups = "drop")

# Order of destinations 
destination_order <- c("Home", "Work or school", "Other's home", "Grocery store", 
                       "Restaurant", "Health clinic", "Outdoors", "Neighbourhood",
                       "Cultural venues", "Place of worship", 
                       "Sport area", "Business")

#my_colors <- kelly(length(destination_order))
my_colors <- c("#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f",
"#ff7f00", "#cab2d6","#6a3d9a","#ffff99","#b15928")

names(my_colors) <- destination_order


destination_percentual <- gss_impedances_renamed %>%
  mutate(dest_label = factor(dest_label, levels = destination_order)) %>%
  group_by(MODE, dest_label, YEAR) %>%
  dplyr::summarise(n = sum(WGHT_EPI), .groups = "drop") %>%
  group_by(MODE, YEAR) %>%
  mutate(percentage = n / sum(n) * 100) %>%
  ungroup() %>%
  group_by(MODE, YEAR) %>%
  mutate(rank = rank(-percentage, ties.method = "first")) %>%
  mutate(label = ifelse(rank <= 5, paste0(round(percentage, 1), "%"), NA)) %>%
  ggplot(aes(x = MODE, fill = dest_label, y = percentage)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(y = "Proportion (%)",
       x = "Mode",
       fill = "Destination") +
  theme_minimal() + 
  facet_wrap(~ as.factor(YEAR)) +
  geom_text(aes(label = label), 
            position = position_fill(vjust = 0.5), size = 3) +
  scale_fill_manual(values = my_colors)

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/destination_percentual.jpg"), 
       plot = destination_percentual,
       width = 12, 
       height = 8, 
       units = "in", 
       dpi = 300)
```

```{r figure-destmodeyearperc, echo=FALSE, out.width="100%", fig.cap="Percentage of walking and cycling trips categorized by destination and year."}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/destination_percentual.jpg"))
```

After 2005, the expansion of the destination highlights some new popular locations. For example, 'Grocery store' appears as the third most chosen destination, varying from almost 10% in 2005 to 14.3% in 2022 for cycling trips and from 12% to 12.6% for walking trips. When considering walking trips, 'Restaurants' appears as another well chosen destination and, in the case of cycling trips, 'Outdoors' appears as a well chosen destination.

```{=html}
<!-- 
Decided to not include the following tables because I transformed them into figures 
start -->
```

```{r table-03X, echo=FALSE, cache=FALSE, warning=FALSE, results="asis", include = FALSE}
# Filter for selected years and calculate statistics of trip duration
episodes_stats_before <- gss_impedances_renamed %>%
  filter(YEAR < 2005) %>%
  group_by(YEAR, dest_label, MODE) %>%
  dplyr::summarise(
    count = sum(WGHT_EPI),
    min = min(DURATION),
    median =  Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages of trips by mode/year 
total_counts <- episodes_stats_before %>% 
  group_by(YEAR, MODE) %>% 
  summarise(total_count = sum(count), 
            .groups = "drop")

episodes_stats_before <- left_join(episodes_stats_before, total_counts, by = c("YEAR", "MODE"))

episodes_stats_before$Percentage <- round((episodes_stats_before$count / episodes_stats_before$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_before %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  )  %>% 
  arrange(MODE, dest_label, desc(Percentage_1998))

wide_data <- wide_data %>%
 dplyr::select(
    MODE, dest_label,
    min_1992, median_1992, max_1992, Percentage_1992,
    min_1998, median_1998, max_1998, Percentage_1998
  ) %>% 
  arrange(MODE, dest_label)

# Latex table
styled_table_03 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:table-03}Comparison of travel statistics by mode and destination: 1992, 1998",
     col.names = c("Destination", "Mode*","Min*","Med*","Max*", "(%)*", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                 font_size = 6) %>%
  # column_spec(1, width = "1cm") %>%  # Set width of 'Dest' column to 1.5cm
  # column_spec(2:14, width = "0.5cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "1992" = 4, "1998" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>% 
  footnote(general = c("* The symbols used in this table represent the following: 'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_table_03 
```

```{r table-04X,echo=FALSE, cache=FALSE, warning=FALSE, include = FALSE}
# Selecting surveys after 2000 and calculating trip duration statistics 
episodes_stats_after <- gss_impedances_renamed %>%
  filter(YEAR > 2000) %>%
  group_by(YEAR, dest_label, MODE) %>%
  dplyr::summarise(
    count = sum(WGHT_EPI),
    min = min(DURATION),
    median =  Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5),
    max = max(DURATION),
    .groups = "drop"
  )

# Calculate percentages of trips by mode/year
total_counts <- episodes_stats_after %>% group_by(YEAR, MODE) %>% summarise(total_count = sum(count), .groups = "drop")
episodes_stats_after <- left_join(episodes_stats_after, total_counts, by = c("YEAR", "MODE"))
episodes_stats_after$Percentage <- round((episodes_stats_after$count / episodes_stats_after$total_count) * 100, 1)

# Pivot data for the table layout
wide_data <- episodes_stats_after %>%
  pivot_wider(
    id_cols = c(dest_label, MODE),
    names_from = YEAR,
    values_from = c(min, median, max, Percentage)
  ) %>%
 dplyr::select(
    MODE, dest_label,
    min_2005, median_2005, max_2005, Percentage_2005,
    min_2010, median_2010, max_2010, Percentage_2010,
    min_2015, median_2015, max_2015, Percentage_2015
  ) %>% 
  arrange(MODE, dest_label)


# Latex table
styled_table_04 <- wide_data %>%
  kable(
    format = "latex", 
    booktabs = TRUE, 
    longtable = TRUE, 
    align = c(rep("c", ncol(wide_data))),
    caption = "\\label{tab:table-04}Comparison of travel statistics by mode and destination: 2005, 2010, 2015",
   col.names = c("Destination", "Mode","Min*","Med*","Max*", "(%)*", "Min","Med","Max", "(%)", "Min","Med","Max", "(%)")
  ) %>%
  kable_styling(full_width = FALSE, 
                #latex_options=c("striped", "scale_down"), 
                latex_options=c("scale_down"),
                font_size = 6) %>%
  #column_spec(1, width = "2cm") %>%  # Set width of 'Dest' column to 1.5cm
  #column_spec(2:14, width = "0.4cm") %>%  # Set width of remaining columns to 0.7cm
  add_header_above(c(" " = 2, "2005" = 4, "2010" = 4, "2015" = 4)) %>%
  row_spec(0, bold = TRUE, align = "c") %>%
  column_spec(6, border_right = TRUE) %>%
  column_spec(10, border_right = TRUE) %>% 
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>% 
  footnote(general = c("* The symbols used in this table represent the following: 'Min' denotes the minimum time to reach the destination; 'Max' denotes the maximum time to reach the destination; '(%)' indicates a percentage of the total time to reach the destination; 'Med' refers to the median time to reach the destination"), threeparttable = T)

styled_table_04
```

```{r include = FALSE}
styled_table_03

styled_table_04
```

```{=html}
<!-- 
Decided to not include the following tables because I transformed them into figures 
start -->
```

Figure \ref{fig:figure-boxplot} presents box plots showing the distribution of travel times for active transport modes over the years, categorized by destination. During the period studied, the typical duration of walking trips was consistently shorter than that of cycling trips. While we can compare the temporal evolution of travel times, some destinations appear only in the two most recent surveys, such as "Neighborhood," "Health clinic," "Sports area," and "Business." The first three showed a constant median walking travel time of 10 minutes in both surveys, while the median travel time to "Business" increased from 10 to 15 minutes. For cycling trips, "Business" recorded no trips, while "Neighborhood" had a typical travel time of 30 minutes in 2015 but no records for 2022. "Health clinic" showed a constant cycling travel time of 15 minutes, and "Sports area" doubled its typical duration, from 15 to 30 minutes.

```{r include = FALSE}
# I created this version to visualize only the medians across destinations, years and mode to facilitate the explanation of the boxplots
destination_medians <- gss_impedances_renamed %>%
  uncount(weights = round(WGHT_EPI)) %>%
  group_by(YEAR, dest_label, MODE) %>%
  summarise(median_duration = median(DURATION), .groups = "drop") %>%
  ggplot(aes(x = as.factor(YEAR), y = median_duration, color = MODE, group = interaction(dest_label, MODE))) +
  geom_line() +  
  geom_point() + 
  geom_text(aes(label = round(median_duration, 1)), 
            vjust = -0.5,  
            size = 3,      
            color = "black") + 
  theme_bw() +   
  facet_wrap(~dest_label) + 
  scale_x_discrete(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022)) +
  labs(
    color = "Mode",                      
    x = "Year",                          
    y = "Travel time (in minutes)") +
  theme(legend.position = "bottom", 
        axis.title.x = element_text(size = 10), 
        axis.title.y = element_text(size = 10),
        legend.title = element_text(size = 10),
        strip.text = element_text(size = 10))

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/destination_medians_weighted.jpg"), 
       plot = destination_medians,
       width = 12, 
       height = 8, 
       units = "in", 
       dpi = 300)
```

```{r destination_boxplots, echo=FALSE, cache=FALSE, include=FALSE}
destination_boxplots <- gss_impedances_renamed %>%
  uncount(weights = round(WGHT_EPI)) %>% 
  ggplot(aes(x = as.factor(YEAR), y = (DURATION), fill = MODE)) +
  geom_boxplot(position = position_dodge(width = 1),
                size = 0.1,
                outlier.shape = NA,
                outlier.size = 0) +  
theme_bw() +   
facet_wrap(~dest_label) + 
  scale_x_discrete(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022)) +
  labs(
    fill = "Mode",                      
    x = "Year",                          
    y = "Travel time (in minutes)") +
    theme(legend.position="bottom", 
          axis.title.x = element_text(size = 10), 
          axis.title.y = element_text(size = 10),
          legend.title = element_text(size = 10),
          strip.text = element_text(size = 10))

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/destination_boxplots.jpg"), 
       plot = destination_boxplots,
       width = 12, 
       height = 8, 
       units = "in", 
       dpi = 300)
```

```{r figure-boxplot, echo=FALSE, out.width="100%", fig.cap="Percentage of walking trips categorized by origin and destination"}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/destination_boxplots.jpg"))
```

For the other destinations, starting with walking trips, we note a trend of increasing travel times for almost all destinations, with an increase observed at least in the most recent survey (2022). "Restaurants" and "Outdoors" both increased their typical travel time from 5 minutes in 2005 to 10 minutes in 2022; "Other's home" rose to 10 minutes in 2022 after remaining at 5 minutes since 1992; "Place of worship" increased from 10 minutes in 2005 to 20 minutes in 2022; and "Cultural venues" rose from 10 minutes in 2005 and 2010 to 20 minutes in 2022. The three most popular types of destinations - "Home," "Work or school," and "Grocery store" - had an increase to 15 minutes after decades of stabilization at 10 minutes. In general, while "Place of worship" and "Cultural venues" displayed the highest median travel times of 20 minutes, the overall median walking time cutoff across all surveys appears to be 10 minutes, with most trips occurring below this threshold. In this case, no destination shows a decrease in typical (median) travel time.

For cycling trips, only "Cultural venues" did not show an increase in typical travel time when comparing 2022 to the previous years. In this case, the travel time dropped from 25 minutes in 2010 to 15 minutes in 2015, although it remained higher than the 2005 value (10 minutes), and no trips were recorded in the most recent survey (2022). "Other's home" is the other destination with no cycling records for the 2022 survey. An increasing trend in travel times is evident for destinations such as "Grocery store" (rising from a median of 10 to 60 minutes between 2005 and 2022) and "Restaurant" (rising to a median of 30 minutes in 2022).

Other destinations seem to follow a similar pattern of increasing travel time, where higher values were recorded in earlier survey cycles, dropped over time, and then rose again in the most recent surveys. This is the case for "Home," which reached its highest typical travel time of 25 minutes after dropping to 10 minutes in 2010. It is also worth mentioning "Work or school," which had a typical cycling travel time of 15 minutes in 1992, peaked at 30 minutes in 1998, dropped back to 15 minutes in 2005 and 2010, and then increased to 25 minutes in 2022. In this case, no destination shows a decrease in typical (median) travel time.

Figures \ref{fig:walking-heatmap} and \ref{fig:cycling-heatmap} show walking and cycling trips from 1992 to 2022 through heat maps. These maps use color gradients to represent the percentage of trips between origins and destinations, with darker colors indicating higher percentages and lighter colors representing less frequent routes. In 1992, walking trips with 'Home' as both the origin and destination made up the majority, accounting for almost 31% of all walking trips. These trips often involved leisure activities, like short walks or dog walking. Following this, trips from 'Home' to 'Work or school' comprised 18% of walking trips. Overall, 'Home' is the principal hub, either as an origin or destination, with only 7% of trips not involving 'Home.' By 1998, more than half of walking trips were between 'Home' and 'Other's home,' with 'Home' to 'Other's home' and 'Other's home' to 'Home' each representing 26% of trips. During this year, 'Home' to 'Home' accounted for only 10% of trips. In 2005, trips with origins or destinations involving 'Home' and 'Work or school' remained as the most common, but the introduction of new destinations led to a more dispersed trip distribution. Together, these two combinations accounted for 25% of all trips. In 2010, trips between 'Home' and 'Work or school' continued as the most common type, representing 18% of trips, tied with trips from 'Grocery store' to 'Home' (9%). In 2015, the highest proportion of trips were from "Home" to "Work or school" (12%) and vice versa (11%). Trips from "Home" to "Home" accounted for 8% of trips, and the "Grocery store" became a notable destination for trips originating from "Home" (8%) - patterns that were reinforced, as shown in the 2022 survey. In the most recent survey, the most common trip was from "Home" to "Work or school" (17%), followed by the return trip from "Work or school" to "Home" (13%). After that, trips between "Home" and the "Grocery store" accounted for 20% when both directions are combined.

```{r make-figs-heatmaps, include=FALSE}
# Walking heat map
walking_hm_fig <- gss_impedances_renamed %>%
  filter(MODE == 'Walking') %>%
  group_by(orig_label, dest_label, YEAR) %>%
  dplyr::summarise(n = sum(WGHT_EPI), .groups = "drop") %>%
  group_by(YEAR) %>%
  mutate(percentage = n / sum(n) * 100) %>%
  ungroup() %>%
  ggplot(aes(x = dest_label,
    y = orig_label)) +
    geom_tile(aes(fill = percentage)) +
    labs(x = "Destination",
    y = "Origin",
    fill = "Percentage (%)") + 
    #geom_text(aes(label = round(percentage)), color = "black", size = 3) + 
    theme_bw() + 
    scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    facet_wrap(~YEAR)

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/walking_hm_fig.jpg"), 
       plot = walking_hm_fig,
       width = 8, 
       height = 5, 
       units = "in", 
       dpi = 300)

# Cycling heat map
cycling_hm_fig <- gss_impedances_renamed %>%
  filter(MODE == 'Cycling') %>%
  group_by(orig_label, dest_label, YEAR) %>%
  dplyr::summarise(n = sum(WGHT_EPI),
  .groups = "drop") %>%
  group_by(YEAR) %>%
  mutate(percentage = n / sum(n) * 100) %>%
  ungroup() %>%
  ggplot(aes(x = dest_label,
    y = orig_label)) +
    geom_tile(aes(fill = percentage)) +
    labs(x = "Destination",
    y = "Origin",
    fill = "Percentage (%)") + 
    #geom_text(aes(label = round(percentage)), color = "black", size = 3) + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    scale_fill_gradientn(colors = RColorBrewer::brewer.pal(9, "YlOrRd")) +
    facet_wrap(~YEAR)

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/cycling_hm_fig.jpg"), 
       plot = cycling_hm_fig,
       width = 8, 
       height = 5, 
       units = "in", 
       dpi = 300)
```

```{r walking-heatmap, echo=FALSE, out.width="100%", fig.cap="Percentage of walking trips categorized by origin and destination"}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/walking_hm_fig.jpg"))
```

```{r cycling-heatmap, echo=FALSE, out.width="100%", fig.cap="Percentage of walking trips categorized by origin and destination"}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/cycling_hm_fig.jpg"))
```

For cycling trips (Figure \ref{fig:cycling-heatmap}), in 1992, the most common trip was from 'Home' to 'Work or school' (26%), followed by trips from 'Other's home' to 'Home' (22%). In all following years, the most frequent trip were between 'Home' and 'Work or school' in both direction. This combination accounted for 65% of the trips in 1998, 40% in 2005, 52% in 2010, and 58% in 2015. However, in 2022, this combination dropped to 43%, mainly due to an increase in trips between the "Grocery store" and "Home" (18%). Additionally and unlike walking trips, 'Home' to 'Home' trips were not a common cycling trip in any of the surveys. This suggests that leisure trips, such as activities around the home, are predominantly done by foot rather than by bicycle. Additionally and unlike walking trips, 'Home' to 'Home' trips were not a common cycling trip in any of the surveys. This suggests that leisure trips, such as activities around the home, are predominantly done by foot rather than by bicycle.

We analyzed whether the temporal differences in travel times for the destinations were statistically significant. Only destinations that appear in more than one survey year can have their temporal evolution analyzed. Therefore, out of the twelve possible destinations, some cycling locations could not be temporally analyzed: "Business," "Neighborhood," and "Place of worship." In the case of walking trips, all destinations could be analyzed over time.

After performing the Kruskal-Wallis test (to assess whether there was a statistically significant difference between the distributions of empirical travel time values, considering the time differences for each destination and the weight of each episode) and the pairwise Wilcoxon test, we were able to identify the destinations where a statistically significant difference was detected. Table \ref{tab:result-stats} shows only the destinations where a statistically significant difference was found, considering the two modes of active transport analyzed.

For both AT modes, the possible destinations had at least two year with statistically significant difference in travel times (p-value \< 2.2e-16). Considering the cycling mode and, for instance, the "Home" destination, there was a statistically significant difference for every possible combination of two survey cycles. This result indicates that the previously discussed increase in typical cycling travel time for home destinations when compared 2022 to 2010 is statistically significant.

```{r kruskal-walking, include = FALSE, warning= FALSE}
result_kw <- data.frame()
anos_possiveis <- c("1992", "1998", "2005", "2010", "2015", "2022")
result_pw <- data.frame(matrix(ncol = length(anos_possiveis) + 2, nrow = 0))
colnames(result_pw) <- c(anos_possiveis, "Mode", "Destination")

# for(mode in unique(theoretical_values$MODE)){
  
#  for(destino in unique(theoretical_values[theoretical_values$MODE == mode, ]$dest_label)){
    
#    subset <- theoretical_values[theoretical_values$MODE == mode & theoretical_values$dest_label == destino, ]
    
for(mode in unique(gss_impedances_renamed$MODE)){
  
  for(destino in unique(gss_impedances_renamed[gss_impedances_renamed$MODE == mode, ]$dest_label)){
    
    subset <- gss_impedances_renamed[gss_impedances_renamed$MODE == mode & gss_impedances_renamed$dest_label == destino, ]
    
    if(length(unique(subset$YEAR)) > 1){
      
    subset <- subset %>% 
      uncount(weights = round(WGHT_EPI))

    kw <- kruskal.test(DURATION ~ YEAR, data = subset)
    
    pv_analise <- ifelse(kw$p.value <= 0.05, 'Significant', 'Not significant')
    
    kw_df <- data.frame("Mode" = mode, "Destination" = destino, "KWpvalue" = kw$p.value, "pvalue" = pv_analise)
    
    result_kw <- rbind(result_kw, kw_df)  
    
    if(kw$p.value <= 0.05){
      
      pw <- pairwise.wilcox.test(subset$DURATION, subset$YEAR, p.adjust.method = "bonferroni")
      
      pf_df <- as.data.frame(pw$p.value)

      for (ano in anos_possiveis) {
    if (!(ano %in% colnames(pf_df))) {
      pf_df[[ano]] <- NA  
    }
  }
  
  pf_df <- pf_df[, anos_possiveis, drop = FALSE]
  
  pf_df$Mode <- mode
  pf_df$Destination <- destino
  
  
  result_pw <- rbind(result_pw, pf_df)
    }
      
    }
  }
}

result_pw$Year <- substr(rownames(result_pw), 1, 4)
rownames(result_pw) <- NULL

result_pw <- result_pw %>%
  filter(rowSums(select(., `1992`:`2022`) <= 0.05, na.rm = TRUE) > 0)

result_pw <- result_pw[, colSums(!is.na(result_pw)) > 0]

result_pw <- result_pw[,c("Mode","Destination","Year","1992","1998","2005","2010","2015")]

result_pw <- result_pw %>%
  mutate(across(where(is.numeric), ~ ifelse(. > 0.05, NA, .)))

result_pw_sci <- result_pw %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2e", .x)))

table_stats <- result_pw_sci %>% 
  kable(format = "latex",
        booktabs = TRUE,
        caption = paste0("\\label{tab:result-stats}P-values of the pairwise Wilcoxon test.")) %>% 
  kable_styling(full_width = FALSE, 
                latex_options = c("scale_down"),
                font_size = 6) %>%
  collapse_rows(columns = 1, valign = "top", latex_hline = "major")
```

```{r pvalues-table,echo=FALSE, cache=FALSE, warning=FALSE}
table_stats
```

### Population with records of active trip

```{r pop-table-with-prevalence, include = FALSE}
# Checking if the person has or active episode 
person_activity <- main_act_eps %>%
  group_by(PUMFID, YEAR, GENDER2, AGE) %>%
  summarise(
    WGHT_PER = first(WGHT_PER),
    has_walk = any(MODE == "Walking" & Count > 0),
    has_cycle = any(MODE == "Cycling" & Count > 0),
    .groups = "drop"
  ) %>%
  mutate(
    has_active = has_walk | has_cycle
  )

# Function to compare shares
get_share_table <- function(df, group_var) {
  df %>%
    group_by(YEAR, {{ group_var }}) %>%
    summarise(
      pop = sum(WGHT_PER),
      walk = sum(WGHT_PER[has_walk]),
      cycle = sum(WGHT_PER[has_cycle]),
      active = sum(WGHT_PER[has_active]),
      .groups = "drop"
    ) %>%
    mutate(
      group = paste0(!!enquo(group_var)),
      perc_walk = 100 * walk / pop,
      perc_cycle = 100 * cycle / pop,
      perc_active = 100 * active / pop
    ) %>%
    select(YEAR, group, perc_walk, perc_cycle, perc_active)
}

# Percentage of active episodes - total population
total_stats <- person_activity %>%
  group_by(YEAR) %>%
  summarise(
    pop = sum(WGHT_PER),
    walk = sum(WGHT_PER[has_walk]),
    cycle = sum(WGHT_PER[has_cycle]),
    active = sum(WGHT_PER[has_active]),
    .groups = "drop"
  ) %>%
  mutate(
    group = "Total",
    perc_walk = 100 * walk / pop,
    perc_cycle = 100 * cycle / pop,
    perc_active = 100 * active / pop
  ) %>%
  select(YEAR, group, perc_walk, perc_cycle, perc_active)

# Percentage of active episodes - gender 
gender_stats <- get_share_table(person_activity, GENDER2)

# Percentage of active episodes - age 
age_stats <- get_share_table(person_activity, AGE)

# Join all tables in one table 
pop_stats <- bind_rows(total_stats, gender_stats, age_stats)

pop_stats <- pop_stats %>%
  pivot_wider(
    names_from = YEAR,
    values_from = c(perc_walk, perc_cycle, perc_active),
    names_glue = "{.value}_{YEAR}"
  )

pop_stats[,2:19] <- round(pop_stats[,2:19],2)

total_pop_year <- person_activity %>%
  group_by(YEAR) %>%
  summarise(total_pop = sum(WGHT_PER), .groups = "drop") %>%
  mutate(YEAR = as.character(YEAR))

pop_stats_table <- pop_stats  %>% 
   kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
         caption = "\\label{tab:pop-stats-table}Prevalence of active trip by transportation mode, year of analysis, gender and age group.",  
         col.names = c(" ","1992","1998", "2005", "2010", "2015", "2022",
                       "1992","1998", "2005", "2010", "2015", "2022", 
                       "1992","1998", "2005", "2010", "2015", "2022"), 
         align = NULL) %>% 
   kable_styling(full_width = FALSE, font_size = 6) %>%
   add_header_above(c(" " = 1, 
                      "Walking" = 6,
                      "Cycling" = 6, 
                      "Walking and Cycling" = 6)) %>% 
  column_spec(1, bold = TRUE) %>% 
  column_spec(7, border_right = TRUE) %>% 
  column_spec(13, border_right = TRUE)
```

The share of the population with active trip records varied between 6.93%, value of 1992, and 15.06%, value of 2015, from 1992 to 2022 (Table \ref{tab:pop-stats-table}). In 2015, the trend of increasing participation in walking and cycling trips was reversed to the beginning of a decline, confirmed by the 2022 survey. In 2015, around 12% of the population recorded at least one active trip. In 2022, this share of the population fell to 9.45%, the lowest level since 2005, representing *2,605,395* people out of a total population of *27,584,823* people.

```{r pop-stats-table, echo=FALSE, cache=FALSE}
pop_stats_table
```

Our results show a decrease in the active population since 2010 for both genders. However, the decline was more pronounced among Women+ than Men+, leading to a shift in the historical pattern in which Women+ had been the more active gender in Canada ([@bryan2009patterns; @borhani2024]). Women+ peaked at 14.82% of the population with a record of active episodes in 2010 but dropped to the second-lowest level of 8.84% in 2022 - only higher than the 7.66% recorded in 1998. In contrast, Men+, who also peaked in 2010 with 15.31% of the population reporting active episodes, declined to 10.05% in 2022, thus becoming the gender with the higher share of the active population.

This result aligns with a trend identified by Borhani et al. ([-@borhani2024]), who examined AT among Canadians using four national health surveys: the National Population Health Survey (1994 - 1998), the Canadian Community Health Survey (2000 - 2020), the Canadian Health Measures Survey (2007 - 2019), and the Health Behaviour in School-aged Children Study (2010 - 2018). Their analysis summarized the prevalence of AT participation and the time spent among those reporting any active trip, focusing on walking and cycling and stratifying the results by age group and sex. In their study, the authors found that a higher proportion of females than males reported engaging in any form of AT, whether walking or cycling, in the last 7 days or 3 months. However, they also observed that this gender gap appears to have narrowed over time.

When analyzing by transportation mode, in all survey years a higher proportion of Men+ reported at least one cycling episode on the previous day compared to Women+ (ranging from 1.18% to 1.87% for Men+ and 0.18% to 0.66% for Women+). This pattern of more Men+ participating in cycling activities when compared to Women+ is consistent with previous research ([@heesch2012; @bryan2009patterns; @borhani2024]). Conversely, Women+ historically reported more walking trips than Men+, also consistent with previous research ([@goel2023; @pollard2017; @bryan2009patterns; @borhani2024]), but this pattern changed in the most recent survey (2022), reinforcing a trend already present in 2015. In 2022, 8.43% of Women+ reported at least one walking episode, compared to 8.89% of Men+.

```{r gender-graphs, include = FALSE}
# Transforming the previous table in a long table to create graphs
gender_stats <- pop_stats %>%
  filter(group %in% c("Men+","Women+")) %>% 
  rename(Gender = group)

long_gender <- gender_stats %>%
  pivot_longer(
    cols = starts_with("perc_"),
    names_to = c("Mode", "Year"),
    names_pattern = "perc_(.*)_(\\d+)",
    values_to = "Value"  
  ) %>%
  mutate(
    Year = as.numeric(Year),
    Mode = case_when(
      Mode == "walk" ~ "Walking",
      Mode == "cycle" ~ "Cycling",
      Mode == "active" ~ "Active",
      TRUE ~ Mode
    )
  ) %>%
  select(Year, Gender, Mode, Value)

# Gender Graph
active_pop_gender_graph <- ggplot(long_gender, aes(x = Year, y = Value, linetype = Gender)) +
  geom_line(linewidth = 0.5) +
  geom_point(size = 0.75) +
  theme_minimal() +
    labs(y = "Percentage (%)", x = "") +  
  scale_x_continuous(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022), guide = guide_axis(angle = 45)) + 
  facet_wrap(~Mode)  +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none"
  )

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/active_pop_gender_graph.jpg"), 
       plot = active_pop_gender_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)
```

```{r gender-duration, include = FALSE}
# Gender
duration_gender_mode <- gss_impedances_renamed %>%
  left_join(main_file %>% select(PUMFID, YEAR, GENDER2, WGHT_PER, dest_label),
            by = c("PUMFID", "YEAR", "dest_label")) %>%
  filter(!is.na(DURATION), DURATION > 0) %>%
  group_by(YEAR, GENDER2, MODE) %>%
  summarise(avg_duration = weighted.mean(DURATION, w = WGHT_EPI, na.rm = TRUE),
    n_episodes = n(),
    .groups = "drop"
  )

duration_gender_mode_total <- gss_impedances_renamed %>%
  left_join(main_file %>% select(PUMFID, YEAR, GENDER2, WGHT_PER, dest_label),
            by = c("PUMFID", "YEAR", "dest_label")) %>%
  filter(!is.na(DURATION), DURATION > 0) %>%
  group_by(YEAR, GENDER2) %>%
  summarise(avg_duration = weighted.mean(DURATION, w = WGHT_EPI, na.rm = TRUE),
    n_episodes = n(),
    .groups = "drop"
  ) %>% mutate(MODE = "Active") %>%
  dplyr::select(YEAR, GENDER2, MODE, avg_duration, n_episodes)

duration_gender <- rbind(duration_gender_mode, duration_gender_mode_total)

duration_gender_graph <- ggplot(duration_gender,
       aes(x = YEAR, y = avg_duration, linetype = GENDER2)) +
  geom_line(linewidth = 0.5) +
   geom_point(size = 0.75) +
  facet_wrap(~ MODE) +
  labs(
    y = "Average Duration (minutes)",
    x = "Year", 
    linetype = "Gender") +
  theme_minimal() +
  scale_x_continuous(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022),
    guide = guide_axis(angle = 45)
  )  +  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    strip.text = element_blank()
  )

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/duration_gender_graph.jpg"), 
       plot = duration_gender_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)

```

```{r active-pop-gender-eps, include = FALSE}
# Code to create graphs about the active population|
# I adapted the previous episodes per person code with the difference that I applied a filter to select only the active population (Count > 0)

person_profile <- main_act_eps %>%
  filter(Count > 0) %>%
  group_by(PUMFID, YEAR) %>%
  summarise(
    is_walker = any(MODE == "Walking"),
    is_cyclist = any(MODE == "Cycling"),
    .groups = "drop"
  ) %>%
  mutate(is_active = is_walker | is_cyclist)

episode_summary_active_only <- main_act_eps %>%
  filter(Count > 0) %>%
  mutate(
    walk_eps = if_else(MODE == "Walking", Total_eps, 0),
    cycle_eps = if_else(MODE == "Cycling", Total_eps, 0)
  ) %>%
  group_by(PUMFID, YEAR, GENDER2, AGE) %>%
  summarise(
    WGHT_PER = first(WGHT_PER),
    walk_eps = sum(walk_eps),
    cycle_eps = sum(cycle_eps),
    .groups = "drop"
  ) %>%
  mutate(active_eps = walk_eps + cycle_eps) %>%
  left_join(person_profile, by = c("PUMFID", "YEAR"))

get_eps_per_active_person_table <- function(df, group_var) {
  df %>%
    group_by(YEAR, {{ group_var }}) %>%
    summarise(
      pop_walkers = sum(WGHT_PER[is_walker]),
      pop_cyclists = sum(WGHT_PER[is_cyclist]),
      active_pop = sum(WGHT_PER[is_active]),
      total_walk = sum(walk_eps),
      total_cycle = sum(cycle_eps),
      total_active = sum(active_eps),
      .groups = "drop"
    ) %>%
    mutate(
      group = paste0(!!enquo(group_var)),
      eps_per_person_walk = total_walk / pop_walkers,
      eps_per_person_cycle = total_cycle / pop_cyclists,
      eps_per_person_active = total_active / active_pop
    ) %>%
    select(YEAR, group, eps_per_person_walk, eps_per_person_cycle, eps_per_person_active)
}

total_eps_stats_active_only <- episode_summary_active_only %>%
  group_by(YEAR) %>%
  summarise(
    active_pop = sum(WGHT_PER),
    total_walk = sum(walk_eps),
    total_cycle = sum(cycle_eps),
    total_active = sum(active_eps),
    .groups = "drop"
  ) %>%
  mutate(
    group = "Total",
    eps_per_person_walk = total_walk / active_pop,
    eps_per_person_cycle = total_cycle / active_pop,
    eps_per_person_active = total_active / active_pop
  ) %>%
  select(YEAR, group, eps_per_person_walk, eps_per_person_cycle, eps_per_person_active)

gender_eps_stats_active_only <- get_eps_per_active_person_table(episode_summary_active_only, GENDER2)
age_eps_stats_active_only <- get_eps_per_active_person_table(episode_summary_active_only, AGE)

episodes_stats_active_only <- bind_rows(
  total_eps_stats_active_only,
  gender_eps_stats_active_only,
  age_eps_stats_active_only
)

episodes_stats_active_only <- episodes_stats_active_only %>%
  pivot_wider(
    names_from = YEAR,
    values_from = c(eps_per_person_walk, eps_per_person_cycle, eps_per_person_active),
    names_glue = "{.value}_{YEAR}"
  ) 

episodes_stats_active_only[,2:19] <- round(episodes_stats_active_only[,2:19],2)
  
eps_gender_stats <- episodes_stats_active_only %>%
  filter(group %in% c("Total", "Men+","Women+")) %>% 
  rename(Gender = group)

long_eps_gender <- eps_gender_stats %>%
  pivot_longer(
    cols = starts_with("eps_"),
    names_to = c("Mode", "Year"),
    names_pattern = "eps_per_person_(.*)_(\\d+)",
    values_to = "Value"  
  ) %>%
  mutate(
    Year = as.numeric(Year),
    Mode = case_when(
      Mode == "walk" ~ "Walking",
      Mode == "cycle" ~ "Cycling",
      Mode == "active" ~ "Active",
      TRUE ~ Mode
    )
  ) %>%
  select(Year, Gender, Mode, Value)

long_eps_gender <- long_eps_gender %>%
  filter(!(Gender == "Total" & Mode != "Active"))

# Gender Graph
eps_gender_graph <- ggplot(long_eps_gender,
                           aes(x = Year, y = Value, linetype = Gender)) +
  geom_line(linewidth = 0.5) +
  geom_point(size = 0.75) +
  theme_minimal() +
    labs(y = "Episodes") +  
  scale_x_continuous(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022), guide = guide_axis(angle = 45)) +
  facet_wrap(~Mode, 
             labeller = labeller(Mode = c("Active" = "Active episodes per active person",
                                          "Walking" = "Walk per walker",
                                          "Cycling" = "Cycle per cyclist")))  +
  theme(legend.position = "bottom")

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/eps_gender_graph.jpg"), 
       plot = eps_gender_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)
```

```{r gender-combinet-plot, include = FALSE}
combined_plot_gender <- active_pop_gender_graph / duration_gender_graph / eps_gender_graph 

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/combined_plot_gender.jpg"), 
       plot = combined_plot_gender,
       width = 20, 
       height = 18, 
       units = "cm", 
       dpi = 300)
```

```{r gender-combined-figure, echo=FALSE, out.width="100%", fig.cap="Analysis by gender."}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/combined_plot_gender.jpg"))
```

When we analyze the population by age group, the youngest (those between 15 and 24 years) stand out as the most active group, ranging from 9.3% to 26.88%, and marking 21.47% in the most recent survey. This is the only group that did not show a decrease in the prevalence of active participation over the last decade, increasing from a low of 17.91% in 2015 to 21.47% in 2022 - although still below the levels recorded in 2010 (24.01%) and 2005 (26.88%). The survey of 2022 is one more evidence of caracterists of the Generation z (born between 1997 and 2012) ([@dimock2019]) are noticeably less dependent on cars and instead use environmentally friendly modes of travel, such as public transport, cycling and walking, more often than not ([@haseeb2024; @grimsrud2014; @kuhnimhof2011]). Historically, and in consistency with the literature ([@bryan2009patterns; @borhani2024]), prevalence decreases as age increases. However, in the most recent survey (2022), as well as in 2005, the oldest group (75 years and older) presented the third-highest prevalence (7.02%), surpassing the groups aged 35 to 44 years (5.78%), 45 to 54 years (6.30%), 55 to 64 years (6.24%), and 65 to 74 years (6.96%).

The analysis by mode shows a similar trend. However, for cycling, the second youngest group (aged 25 to 34 years) had the highest prevalence in the 2022 survey (1.62%), surpassing the youngest group (1.58%). For all other age groups, cycling prevalence decreases as age increases, approaching 0.10% for the oldest group (75 years and older).

```{r active_pop_age_proportion, include = FALSE}
# Transforming the previous table in a long table to create graphs (age version)
age_stats <- pop_stats %>%
  filter(!group %in% c("Total","Men+","Women+")) %>% 
  rename(Age = group)

long_age <- age_stats %>%
  pivot_longer(
    cols = starts_with("perc_"),
    names_to = c("Mode", "Year"),
    names_pattern = "perc_(.*)_(\\d+)",
    values_to = "Value"  
  ) %>%
  mutate(
    Year = as.numeric(Year),
    Mode = case_when(
      Mode == "walk" ~ "Walking",
      Mode == "cycle" ~ "Cycling",
      Mode == "active" ~ "Active",
      TRUE ~ Mode
    )
  ) %>%
  select(Year, Age, Mode, Value)

age_palette <-  c("#D53E4F", "#FC8D59", "#ffd92f","#E5E5AB", "#E6F598", "#99D594", "#3288BD")

#Age Graph
active_pop_age_graph <- ggplot(long_age, 
                                    aes(x = Year, y = Value, color = Age)) +
  geom_line(linewidth = 0.6) +
  geom_point(size = 0.75) +
  theme_minimal() +
  labs(y = "Percentage (%)") +  
  scale_x_continuous(breaks = c(1992, 1998, 2005, 2010, 2015, 2022), guide = guide_axis(angle = 45)) +
  scale_color_manual(values = age_palette) + 
  facet_wrap(~ as.factor(Mode)) +
  labs(color = "Age") + 
  facet_wrap(~Mode)  +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none"
  )

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/active_pop_age_graph.jpg"), 
       plot = active_pop_age_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)
```

```{r age-duration, include=FALSE}
# Age 
duration_age_mode <- gss_impedances_renamed %>%
  left_join(main_file %>% select(PUMFID, YEAR, AGE, WGHT_PER, dest_label),
            by = c("PUMFID", "YEAR", "dest_label")) %>%
  filter(!is.na(DURATION), DURATION > 0) %>%
  group_by(YEAR, AGE, MODE) %>%
  summarise(avg_duration = weighted.mean(DURATION, w = WGHT_EPI, na.rm = TRUE),
    n_episodes = n(),
    .groups = "drop"
  ) 

duration_age_mode_total <- gss_impedances_renamed %>%
  left_join(main_file %>% select(PUMFID, YEAR, AGE, WGHT_PER, dest_label),
            by = c("PUMFID", "YEAR", "dest_label")) %>%
  filter(!is.na(DURATION), DURATION > 0) %>%
  group_by(YEAR, AGE) %>%
  summarise(avg_duration = weighted.mean(DURATION, w = WGHT_EPI, na.rm = TRUE),
    n_episodes = n(),
    .groups = "drop"
  ) %>% mutate(MODE = "Active") %>%
  dplyr::select(YEAR, AGE, MODE, avg_duration, n_episodes)

duration_age <- rbind(duration_age_mode, duration_age_mode_total)


duration_age_graph <- ggplot(duration_age,
                           aes(x = YEAR, y = avg_duration, color = AGE)) +
  geom_line(linewidth = 0.6) +
  theme_minimal() + 
  geom_point(size = 0.75) + 
    scale_color_manual(values = age_palette) + 
  labs(
    y = "Average Duration (minutes)",
    x = "Year", 
    color = "Age") +
  scale_x_continuous(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022), guide = guide_axis(angle = 45)) +   
  facet_wrap(~MODE)  +  
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    legend.position = "none",
    strip.text = element_blank()
  )

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/duration_age_graph.jpg"), 
       plot = duration_age_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)
```

```{r age-eps, include = FALSE}
age_stats_eps <- episodes_stats_active_only %>%
  filter(!group %in% c("Total","Men+","Women+")) %>% 
  rename(Age = group)

long_age_eps <- age_stats_eps %>%
  pivot_longer(
    cols = starts_with("eps_"),
    names_to = c("Mode", "Year"),
    names_pattern = "eps_per_person_(.*)_(\\d+)",
    values_to = "Value"  
  ) %>%
  mutate(
    Year = as.numeric(Year),
    Mode = case_when(
      Mode == "walk" ~ "Walking",
      Mode == "cycle" ~ "Cycling",
      Mode == "active" ~ "Active",
      TRUE ~ Mode
    )
  ) %>%
  select(Year, Age, Mode, Value)

# Age Graph
eps_age_graph <- ggplot(long_age_eps,
                           aes(x = Year, y = Value, color = Age)) +
  geom_line(linewidth = 0.6) +
  geom_point(size = 0.75) +
  theme_minimal() + 
    scale_color_manual(values = age_palette) + 
    labs(y = "Episodes") +  
  scale_x_continuous(
    breaks = c(1992, 1998, 2005, 2010, 2015, 2022), guide = guide_axis(angle = 45)) +   
  facet_wrap(~Mode, 
             labeller = labeller(Mode = c("Active" = "Active episodes per active person",
                                          "Walking" = "Walk per walker",
                                          "Cycling" = "Cycle per cyclist"))) +
  theme(legend.position = "bottom")

# Saving figure
ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/eps_age_graph.jpg"), 
       plot = eps_age_graph,
       width = 20, 
       height = 5, 
       units = "cm", 
       dpi = 300)
```

```{r age-combinet-plot, include = FALSE}
combined_plot_gender <- active_pop_age_graph / duration_age_graph / eps_age_graph 

ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/combined_plot_age.jpg"), 
       plot = combined_plot_gender,
       width = 20, 
       height = 18, 
       units = "cm", 
       dpi = 300)
```

```{r age-combined-figure, echo=FALSE, out.width="100%", fig.cap="Analysis by age."}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/combined_plot_age.jpg"))
```

The number of people with active trip episodes is mainly influenced by walking episodes, since over 90% of the recorded active trips involve individuals with walking episodes. Analyzing the number of episodes per person for the general population, the rate ranges from a minimum of 0.13 in 1998 to a maximum of 0.31 in 2010 \ref{tab:eps-total-pop}.

```{r episodes-per-group-table, include = FALSE}
episode_summary <- main_act_eps %>%
  mutate(
    walk_eps = if_else(MODE == "Walking", Total_eps, 0),
    cycle_eps = if_else(MODE == "Cycling", Total_eps, 0)
  ) %>%
  group_by(PUMFID, YEAR, GENDER2, AGE) %>%
  summarise(
    WGHT_PER = first(WGHT_PER),
    walk_eps = sum(walk_eps),
    cycle_eps = sum(cycle_eps),
    .groups = "drop"
  ) %>%
  mutate(active_eps = walk_eps + cycle_eps)

# Function to compute average episodes per person
get_eps_per_person_eps_table <- function(df, group_var) {
  df %>%
    group_by(YEAR, {{ group_var }}) %>%
    summarise(
      pop = sum(WGHT_PER),
      total_walk = sum(walk_eps),
      total_cycle = sum(cycle_eps),
      total_active = sum(active_eps),
      .groups = "drop"
    ) %>%
    mutate(
      group = paste0(!!enquo(group_var)),
      eps_per_person_walk = total_walk / pop,
      eps_per_person_cycle = total_cycle / pop,
      eps_per_person_active = total_active / pop
    ) %>%
    select(YEAR, group, eps_per_person_walk, eps_per_person_cycle, eps_per_person_active)
}

total_eps_stats <- episode_summary %>%
  group_by(YEAR) %>%
  summarise(
    pop = sum(WGHT_PER),
    total_walk = sum(walk_eps),
    total_cycle = sum(cycle_eps),
    total_active = sum(active_eps),
    .groups = "drop"
  ) %>%
  mutate(
    group = "Total",
    eps_per_person_walk = total_walk / pop,
    eps_per_person_cycle = total_cycle / pop,
    eps_per_person_active = total_active / pop
  ) %>%
  select(YEAR, group, eps_per_person_walk, eps_per_person_cycle, eps_per_person_active)

gender_eps_stats <- get_eps_per_person_eps_table(episode_summary, GENDER2)

age_eps_stats <- get_eps_per_person_eps_table(episode_summary, AGE)

episodes_stats <- bind_rows(total_eps_stats, gender_eps_stats, age_eps_stats) %>% 
  mutate(eps_per_person_walk = round(eps_per_person_walk, 2), 
         eps_per_person_cycle = round(eps_per_person_cycle, 2),
         eps_per_person_active = round(eps_per_person_active, 2))

episodes_stats <- episodes_stats %>%
  pivot_wider(
    names_from = YEAR,
    values_from = c(eps_per_person_walk, eps_per_person_cycle, eps_per_person_active),
    names_glue = "{.value}_{YEAR}") 

eps_person_stats_table <- episodes_stats  %>% 
   kable(format = "latex", booktabs = TRUE, longtable = TRUE, 
         caption = "\\label{tab:eps-total-pop}Episodes of active trip per person by transportation mode, year of analysis, gender and age group.",  
         col.names = c(" ","1992","1998", "2005", "2010", "2015", "2022",
                       "1992","1998", "2005", "2010", "2015", "2022", 
                       "1992","1998", "2005", "2010", "2015", "2022"), 
         align = c('l', rep('c', ncol(pop_stats) - 1))) %>% 
   kable_styling(full_width = FALSE, font_size = 6) %>%
   add_header_above(c(" " = 1, 
                      "Walking" = 6,
                      "Cycling" = 6, 
                      "Walking and Cycling" = 6)) %>% 
  column_spec(1, bold = TRUE) %>% 
  column_spec(7, border_right = TRUE) %>% 
  column_spec(13, border_right = TRUE)
```

Considering only the population with active episodes recorded, the average is around 1.96 active episodes per person, varying from a maximum of 2.10 episodes in 2005 to a minimum of 1.72 episodes per person in 1992. Figure \ref{fig:gender-eps-figure} presents, for each survey year, the total number of active episodes divided by the population with active records, the number of walking episodes per person who walked, and the number of cycling episodes per person who cycled - all disaggregated by gender. Until 2022, Men+ historically had more number of active episodes when compared to Women+, but this pattern changed in the last survey when Men+ scored 2.07 active episodes, when compared to 2.11 active episodes made by Women+. This was mainly caused by the decreasing of number of walking episodes made by Men+ (from 2.16 to 2.07 from 2015 to 2022), and increase of walking episodes made by Women+ (from 1.92 to 2.11 in the same period).

The same type of metric shown in Figure \ref{fig:gender-eps-figure} can also be calculated by age group. Figure \ref{fig:age-eps-figure} shows that active individuals in the oldest age group (those aged 75 and over) have been on an increasing trend in the number of active episodes since 2010. In 2010, this group ranked last in the number of active episodes per active person (1.94), and by 2022, it had taken first place with 2.21 episodes per active person (a 14% increase). In general, all age groups have improved their performance compared to 1992. However, over a shorter period between the two most recent surveys (2015 and 2022), the group aged 25 to 34 is the only one that showed a decrease in the number of active episodes per active person, decreasing from 2.27 to 1.93 episodes (15% of reduction).

When the age group analysis is split by transportation mode, walking episodes per walker follow a pattern similar to that of total active episodes per active person (Figure \ref{fig:age-eps-figure}). However, the pattern for cycling differs. For almost every group, the data can be divided into two distinct time periods: before and after 2005. From 1992 to 2005, there was a general trend of increasing cycling episodes per cyclist (from 1.72 to 2.10). This trend is exemplified by the 55 to 64 age group, which increased from 1.58 to 2.61 episodes (a 65% rise). This period was followed by a decline in cycling episodes per cyclist from 2005 to 2022 (from 2.10 to 2.04). A clear example of this trend is the 65 to 74 age group, which saw a decrease from 2.73 to 1.60 episodes (a reduction of 41%). In more recent years, only two age groups show an increasing trend in cycling episodes per cyclist when comparing the last two surveys (2015 and 2022): the youngest group (15 to 24 years) and the oldest (75 and over). In both cases, there was a significant increase. The youngest group rose from 1.78 to 3.00 episodes (a 40% increase), while the oldest group doubled its average from 1.00 to 2.00 episodes over the seven years.

Evaluating the analysis in terms of the average duration of active episodes, we observe an increase in duration for both genders and for both transportation modes after 2010. For cycling trips, Men+ increased their average duration from 19 minutes in 2010 to 33 minutes in 2022, while Women+ went from 15 minutes in 2010 to 22 minutes in 2022 - although this follows a slight decline from a peak of 24 minutes in 2015. This upward trend in travel time contrasts with the period from 1992 to 2010, during which both genders experienced a reduction in duration, reaching their lowest levels in 2010.

For walking trips, the highest average travel times were recorded in 1992, with Men+ averaging 19 minutes and Women+ 21 minutes. These figures dropped to their lowest point in 1998 (12 minutes for Men+ and 11 for Women+) before gradually increasing again through to 2022. Since 2015, Women+ have reported longer walking durations than Men+ (19 minutes compared to 17 minutes in 2022). Regardless of the mode, Men+ reported slightly longer overall active travel durations than Women+ in 2022 (19 minutes and 21 seconds vs. 19 minutes and 11 seconds). These results align with findings from previous studies on the Canadian population ([@bryan2009patterns; @borhani2024]).

An examination of average travel duration by age group reveals a general increase in walking trip durations across all groups since 1998. In 2022, the youngest cohort (ages 15 to 24) reported the shortest average walking duration at 17 minutes, while the 25 to 34 age group had the longest, averaging 21 minutes. For cycling trips, a notable increasing trend in duration emerges after 2010 - with the exception of the 55 to 64 age group, whose average duration stabilized following a peak in 2015. Notably, the 65 to 74 age group recorded the highest average cycling duration, with individuals in this cohort spending an average of 42 minutes cycling in 2022.

## Calibrated impedance function

After analyzing the active travel episodes and population with records of active trip, this section presents the identified impedance functions for walking and cycling trips to various destinations across CMA/CA in Canada from 1992 to 2022. In general, the impedance functions aim to capture transportation behavior, illustrating that the likelihood of traveling between two points decreases as travel duration increases. Each impedance function follows one of the mathematical equations previously mentioned, enabling the plotting of PDF curves. These curves also highlight critical points at which a person's tendency to walk or cycle significantly decreases.

As explained in the methodology section, we used the `fitdistrplus` package [@delignette2015fitdistrplus] to calibrate the functions. We selected the best impedance function for each transportation mode, destination, and year based on the lowest Akaike Information Criterion (AIC) value [@akaike1974]. The AIC metric not only assesses the goodness of fit but also penalizes model complexity to prevent overfitting. AIC provides a balance between a model's accuracy and simplicity, with lower values indicating a more economical model. The distribution with the lowest AIC was considered the most suitable for representing the distance decay curve for each specific destination in each year. We chose AIC as the selection criterion because, while the `fitdistrplus` package accommodates weighted episodes during estimation, it does not extend this functionality to diagnostic plots, which are typically unweighted and traditionally used to select the best-fitting function.

```{r selected_functions,echo=FALSE, cache=FALSE, warning=FALSE, include=FALSE}
selected_functions <- gss_impedances_renamed %>% 
  group_by(MODE, YEAR, dest_label) %>% 
  dplyr::summarise(Function = first(f_name), 
            est_1 = first(est_1),
            est_2 = first(est_2),
            AIC = first(aic),
            f_name = first(f_name),
            count = first(count),
            .groups = "drop") %>% 
  mutate(Function = case_when(
    Function == "lnorm" ~ "Lognormal",
    Function == "gamma" ~ "Gamma",
    Function == "unif" ~ "Uniform",
    Function == "norm" ~ "Normal",
    TRUE ~ Function), 
  across(c(est_1,est_2), ~ round(., digits = 2)), 
  across(c(AIC), ~ round(., digits = 0))) %>% 
  rename(Mode = MODE, Year = YEAR, Destination = dest_label)

walking_functions_table <- selected_functions %>%
  arrange(Year, Destination) %>% 
  filter(Mode == 'Walking') %>% 
  select(Year, Destination, Function,est_1,est_2, AIC, count) %>%
  kable(format = "latex",
        booktabs = TRUE,
        caption = paste0("\\label{tab:walking-functions-tab}Impedance functions and AIC for walking trips."), 
        col.names = c("Year", "Destination", "Impedance function","Parameter 1*","Parameter 2*", "AIC", "Count")) %>%
    kable_styling(full_width = FALSE, 
                latex_options=c("scale_down"),
                font_size = 8) %>% 
  row_spec(0, bold = TRUE, align = "c") %>% 
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
  footnote(general = c("For lognormal distributions, 'Parameter 1' and 'Parameter 2' refer to the mean and standard deviation of the distribution on the logarithmic scaler, respectively. For Gamma distributions, 'Parameter 1' and 'Parameter 2' refer to the rate and shape of the distribution, respectively. For uniform distributions,  'Parameter 1' refers to the minimum lower bound and 'Parameter 2'  refers to the upper bound (maximum) of the distribution.  'AIC' means Akaike information criterion."), threeparttable = T)

biking_functions_table <- selected_functions %>%
  arrange(Year, Destination) %>% 
  filter(Mode == 'Cycling') %>% 
  select(Year, Destination, Function, est_1, est_2, AIC, count) %>%
  kable(format = "latex",
        booktabs = TRUE,
        caption = paste0("\\label{tab:cycling-functions-tab}Impedance functions and AIC for cycling trips."), 
        col.names = c("Year", "Destination", "Impedance function","Parameter 1*","Parameter 2*", "AIC", "Count")) %>% 
    kable_styling(full_width = FALSE, 
                latex_options=c("scale_down"),
                font_size = 8) %>% 
  row_spec(0, bold = TRUE, align = "c") %>% 
  collapse_rows(columns = 1, valign = "top", latex_hline = "major") %>%
  footnote(general = c("For lognormal distributions, 'Parameter 1' and 'Parameter 2' refer to the mean and standard deviation of the distribution on the logarithmic scaler, respectively. For normal distributions, 'Parameter 1' and 'Parameter 2' refer to the mean and standard deviation of the distribution, respectively. For the gamma distributions, 'Parameter 1' and 'Parameter 2' refer to the rate and shape of the distribution, respectively. For the uniform distribution,  'Parameter 1' refers to the minimum lower bound and 'Parameter 2'  refers to the upper bound (maximum) of the distribution.  'AIC' means Akaike information criterion."), threeparttable = T)
```

In total, we fitted `r nrow(selected_functions)` impedance functions. Among the candidate distributions, only the negative exponential type was not selected. The absence of exponential functions, given the variety of destinations, year and mode of transport, indicates that the impedance functions applied in active accessibility studies may not be adequately measuring travel behavior, especially for cases when the travel time is close to 0 minute. Table \ref{tab:walking-functions-tab} displays the selected functions for walking trips, while Table \ref{tab:cycling-functions-tab} presents the functions for cycling trips. Appendix A includes the AIC, BIC, and log-likelihood values for all candidate distributions.

```{r walking_functions_table,echo=FALSE, cache=FALSE, warning=FALSE}

walking_functions_table
```

```{r biking_functions_table,echo=FALSE, cache=FALSE, warning=FALSE}

biking_functions_table
```

Figure \ref{fig:outdoors-impedance-fig} presents the calibrated functions for the destination 'Outdoors,' along with a histogram of the empirical distribution of trips, split by year and transportation mode. Comparing functions from different categories can be difficult when analyzed for the first time, but by starting with the functions from the walking transportation mode (blue curves), the calibrated functions from this example show a similar pattern. At a duration of around zero minutes, the probability of making the trip is lower (with a density of zero for the years 2015 and 2022). After a few minutes, there is a peak in the maximum probability of traveling to reach 'Outdoors,' followed by a drop in willingness to zero for very high values of time, indicating a low probability of making the trip.

```{r mean_functions, include = FALSE}
mean_functions <- selected_functions %>% 
  group_by(Function) %>%
  dplyr::summarise(mean = mean(count))

mean_gamma <- round(mean_functions[mean_functions$Function == 'Gamma', ]$mean)
mean_uniform <- round(mean_functions[mean_functions$Function == 'Uniform', ]$mean)
mean_lognormal <- round(mean_functions[mean_functions$Function == 'Lognormal', ]$mean)
```

```{r theoretical_impedance_values, include = FALSE}
theoretical_impedance <- function(df_functions, travel_cost) {
  
  # Initialize the main data frame to store results
  result <- data.frame()
  
  # Create the 't' sequence
  t_seq <- seq(1, travel_cost, 1)
  
  for (mode in unique(df_functions$Mode)){
    
    for (year in unique(df_functions[df_functions$Mode == mode, ]$Year)){ 
      
      for (destino in unique(df_functions[df_functions$Year == year & df_functions$Mode == mode, ]$Destination)){
        
      name_function <- df_functions[df_functions$Year == year & 
                                      df_functions$Mode == mode & 
                                      df_functions$Destination == destino, ]$f_name
      
      print(paste0("YEAR: ", year, " MODE: ", mode," Destination: ", destino))
      
      subset <- df_functions %>% 
        filter(Year == year & Mode == mode & Destination == destino)
      
      # Temporary data frame for this iteration
      temp_df <- data.frame(t = t_seq)
      
      # Add the appropriate distribution
      if (name_function == "lnorm") {
        temp_df$f <- dlnorm(temp_df$t,
                            meanlog = subset$est_1[1],
                            sdlog = subset$est_2[1])
        
      } else if (name_function == "gamma") {  
        temp_df$f <- dgamma(temp_df$t,
                            shape = subset$est_1[1],
                            rate = subset$est_2[1])
        
      } else if (name_function == "norm") {  
        temp_df$f <- dnorm(temp_df$t,
                           mean = subset$est_1[1],
                           sd = subset$est_2[1])
        
      } else if (name_function == "exp") {  
        temp_df$f <- dexp(temp_df$t,
                          rate = subset$est_1[1])
        
      } else if (name_function == "unif") {  
        temp_df$f <- dunif(temp_df$t,
                           min = subset$est_1[1],
                           max = subset$est_2[1])
      }
      
      # Add mode, year and destination columns
      temp_df$MODE <- mode
      temp_df$YEAR <- year
      temp_df$dest_label <- destino
        
      # Append to the result data frame
      result <- rbind(result, temp_df)
    }
  }
}
  return(result)
}

theoretical_values <- theoretical_impedance(selected_functions, travel_cost = max_duration)
```

```{r include = FALSE}

for(destino in unique(gss_impedances_renamed$dest_label)){
  
  medianas <- gss_impedances_renamed %>%
    filter(dest_label == destino) %>%
    group_by(MODE) %>%
    dplyr::summarise(mediana_duracao = Hmisc::wtd.quantile(DURATION, weights = WGHT_EPI, probs = 0.5), .groups = 'drop')
  
  maximos <- theoretical_values %>%
    filter(dest_label == destino) %>%
    group_by(MODE, YEAR) %>%
    filter(f == max(f)) %>%
    slice(which.max(t)) %>%
    ungroup()
  
combined_plot <- gss_impedances_renamed %>% 
  filter(dest_label == destino) %>%
  mutate(dest_label = factor(dest_label, levels = destination_order)) %>%
  ggplot(aes(x= DURATION)) +
  geom_histogram(aes(y = ..density.., colour = MODE, fill = MODE), bins = 20, alpha=0.1, position="identity") + 
  geom_line(data = theoretical_values[theoretical_values$dest_label == destino, ], aes(x = t, y = f, colour = MODE), size = 0.8) +   
  geom_vline(data = medianas, aes(xintercept = mediana_duracao, color = MODE), linetype = "dashed") + 
  geom_point(data = maximos, aes(x = t, y = f, colour = MODE), size = 3) + 
  geom_label(data = maximos, aes(x = t, y = f, label = round(t, 2), colour = MODE), 
            vjust = 0, size = 3) +
  theme_minimal() +
  facet_wrap(~YEAR) + 
  labs(x = "Trip duration (in minutes)", y = "Density", colour = "Transportation Mode", fill = "Transportation Mode") +
  theme(legend.position="right", 
    strip.text = element_text(face = "bold", hjust = 0))

  plots <- length(unique(gss_impedances_renamed[gss_impedances_renamed$dest_label == destino, ]$YEAR))
 
  # Case of only one year 
    if(plots == 1){
      ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/impf_",destino,".jpg"), 
       plot = combined_plot,
       width = 7, 
       height = 4, 
       units = "in", 
       dpi = 300)
    
    # Destination present in 3 surveys  
    } else if(plots == 3){
      ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/impf_",destino,".jpg"), 
       plot = combined_plot,
       width = 14, 
       height = 4, 
       units = "in", 
       dpi = 300)
      
  # Destination present in 5 surveys  
    }else {
      ggsave(file = paste0(here::here(),"/Journal-manuscript/figures/impf_",destino,".jpg"), 
       plot = combined_plot,
       width = 14, 
       height = 9, 
       units = "in", 
       dpi = 300)
    }
}
```

```{r outdoors-impedance-fig, echo=FALSE, out.width="100%", fig.cap=paste0("Empirical data and impedance functions fitted for walking trips with `work or school` as destination."), fig.align="center"}
# selecting mode and destination to display impedance functions
mode <- "Walking" 
destino <- "Outdoors"

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/impf_",destino,".jpg"))
```

For the years 2005 and 2010, the selected impedance functions are of the gamma type, with shapes of $\alpha = 1.24$ and $\alpha = 1.27$, respectively, and the same rate of $\sigma = 0.13$. The rate parameter ($\sigma$) mainly controls the speed of the curved drop, which is the same for both years. The shape parameter ($\mu$) controls how the density peak shifts in relation to the $x$-axis (the travel time). A larger shape value means that the probability peak occurs at larger values of time. Since the shape values for 2005 and 2010 are very close, the peak of the PDF curve in both cases occurs at 2 minutes. Although the difference in shape ($\mu$) between the two years is small and does not change the time at which the peak occurs, it is enough to cause a difference in the peak values themselves. In 2005, the walking trips had a higher density around 2 minutes (0.079) compared to 2010 (0.077).

For 2015 and 2022, the PDFs that best represent the population's transport behavior are lognormal distributions, with a mean of $\mu = 2.54$ and a standard deviation of $\sigma = 0.79$ for 2015, and a mean of $\mu = 2.27$ and a standard deviation of $\sigma = 0.77$ for 2022. In 2015, the density peak (0.05) occurs at a journey duration of 7 minutes. Here, we observe that a lower density peak corresponds to a more dispersed curve, with higher densities at longer durations. In fact, while in 2005 and 2010 walking trips had densities close to zero for durations over 50 minutes, in 2015 there is still a small density (0.002) at the 50-minute mark. In 2022, the density peak (0.07) occurs at a duration of 5 minutes, and the curve is less dispersed than in 2015, registering lower densities near the 50-minute mark (0.01), in comparison.

For trips made by bicycle, the best-fitting impedance function in 2005 is of the gamma type. For 2010 and 2022, the impedance functions are best represented by lognormal distributions. In 2015, the PDF that best fits the data is a uniform distribution, with an upper bound of 35 minutes and a peak density of 0.028. The presence of uniform functions means that it was not possible to parameterize more complex functions (like the other functions) and is explained by the low number of episodes in this category of destination, mode of transport and year (in this case, there were only 3 episodes identified). Overall, all the uniform functions have a maximum of 6 episodes and all of them are for the transportation mode cycling - which can be explained since this mode of transport does not have many episodes compared to the walking episodes (only 7% of active travel episodes). The figure also shows how cycling trips tend to have greater dispersion and higher typical values (dashed vertical lines) when compared to walking trips.

The complexity of the impedance function depends on the number of episodes available for calibration. For instance, fitting a gamma-type function required an average of `r mean_gamma` episodes, while fitting a lognormal function required approximately `r mean_lognormal` episodes. In contrast, fitting a normal function required only 5 episodes, and fitting a uniform function required, on average, just `r mean_uniform` episodes.

The temporal difference between the decay functions is also evident in Figure \ref{fig:walking-evolution-fig}, which shows the calibrated functions for each year of analysis across all destination and transport mode categories for walking trips. For some locations, the impedance functions are of the same type and have similar parameters across all the years analyzed. For example, the "Cultural venues", consistently uses a gamma function to represent the population's transport behavior for all the years analyzed. On the other hand, the "Place of worship" destination exhibits temporal differences, with distinctly different peaks and density dispersions, reflecting the variations in the empirical data shown in Figure \ref{fig:figure-boxplot} and discussed above.

```{r figure-walking-evolution, include = FALSE}
year_order <- c(1992,1998,2005,2010,2015,2022)

#my_colors <- kelly(length(destination_order))
my_colors_years <- c("#cbd9bf","#bae4bc","#7bccc4","#43a2ca","#0868ac","#053c63")

names(my_colors_years) <- year_order


walking_temporal_evolution <- theoretical_values %>%
  filter(MODE == 'Walking') %>%
  ggplot(aes(x=t, y=f, color = as.factor(YEAR))) +
  geom_line(size = 1) + 
  theme_minimal() +
  facet_wrap(~ dest_label) + 
  scale_color_manual(values = my_colors_years) +
  labs(x = "Walking trip duration", y = "Density", color = "Year") + 
  theme(
    strip.text = element_text(face = "bold", hjust = 0))


Cycling_temporal_evolution <- theoretical_values %>%
  filter(MODE == 'Cycling') %>%
  ggplot(aes(x=t, y=f, color = as.factor(YEAR))) +
  geom_line(size = 1) + 
  theme_minimal() +
  facet_wrap(~ dest_label) + 
  scale_color_manual(values = my_colors_years) +
  labs(x = "Cycling trip duration", y = "Density", color = "Year") + 
  theme(
    strip.text = element_text(face = "bold", hjust = 0))

ggsave(paste0(here::here(),"/Journal-manuscript/figures/walking_temporal_evolution.jpg"), walking_temporal_evolution, 
       width = 10, 
       height = 7, 
       units = "in", 
       dpi = 300)


ggsave(paste0(here::here(),"/Journal-manuscript/figures/cycling_temporal_evolution.jpg"), Cycling_temporal_evolution, 
       width = 10, 
       height = 7, 
       units = "in", 
       dpi = 300)
```

```{r walking-evolution-fig, echo=FALSE, out.width="100%", fig.cap=paste0("Temporal evolution of walking impedance functions."), fig.align="center"}

knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/walking_temporal_evolution.jpg"))
```

<!-- criar um paragrafo explicando a diferenca entre as duas figuras -->

```{r figure-walk-func-by-year, include = FALSE}
walking_func_by_year <- theoretical_values %>%
  filter(MODE == 'Walking') %>%
  mutate(dest_label = factor(dest_label, levels = destination_order)) %>%
  ggplot(aes(x=t, y=f, color = dest_label)) +
  theme_minimal() +
  geom_line(size = 1) + 
  facet_wrap(~YEAR   ) + 
  scale_color_manual(values = my_colors) +
  labs(x = "Walking trip duration", y = "Density", color = "Destination") + 
  theme(
    strip.text = element_text(face = "bold", hjust = 0))

ggsave(paste0(here::here(),"/Journal-manuscript/figures/walking_functions_by_year.jpg"), walking_func_by_year, 
       width = 10, 
       height = 5, 
       units = "in", 
       dpi = 300)
```

```{r walking-function-by-year-fig, echo=FALSE, out.width="100%", fig.cap=paste0("Walking functions grouped by year."), fig.align="center"}
# 
# knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/walking_functions_by_year.jpg"))
```

```{r bike-figure-func-by-year, include = FALSE}
functions_by_year <- theoretical_values %>%
  filter(MODE == 'Cycling') %>%
  mutate(dest_label = factor(dest_label, levels = destination_order)) %>%
  ggplot(aes(x=t, y=f, color = dest_label)) +
  theme_minimal() +
  geom_line(size = 1) + 
  facet_wrap(~YEAR   ) + 
  scale_color_manual(values = my_colors) +
  labs(x = "Cycling trip duration", y = "Density", color = "Destination") + 
  theme(
    strip.text = element_text(face = "bold", hjust = 0))

ggsave(paste0(here::here(),"/Journal-manuscript/figures/cycling_functions_by_year.jpg"), functions_by_year, 
       width = 10, 
       height = 5, 
       units = "in", 
       dpi = 300)
```

```{r cycling-function-by-year-fig, echo=FALSE, out.width="100%", fig.cap=paste0("Cycling functions grouped by year."), fig.align="center"}

# knitr::include_graphics(paste0(here::here(),"/Journal-manuscript/figures/cycling_functions_by_year.jpg"))
```

# Summary and conclusion

The main objectives of this study were to provide an overview of AT in Canadian metropolitan cities, focusing on main origins, destinations, travel times and active population on terms of age group and sex, and to identify appropriate impedance functions for AT modes across various destinations and time periods. In this study we perform a direct application of `ActiveCA` R package [@dossantos2024ActiveCA], analyzing over 13,500 cases of active travel trips that represented `r format(gss_summary[gss_summary$Mode == 'Total',]$Total, big.mark = ",", scientific = FALSE)` episodes, from the Time Use cycles of the General Social Survey (GSS) from 1992 to 2022, covering a twelve different type of destinations and considering walking and cycling as transportation modes.

Our results show that the typical duration of walking trips increased to 15 minutes by 2022, following years of stability at 10 minutes. For cycling, the typical duration rose to 30 minutes, recovering from a decline that began in 1998 and lasted until 2010. Generally, walking trips had consistently shorter durations than cycling trips. When analyzed by gender, both Men+ and Women+ experienced increases in trip duration for both walking and cycling after 2010. Although this study does not explain the causes of these fluctuations, the differences by year and mode were statistically significant.

For both transportation modes, trips to "Other's home" declined over time, likely reflecting changing social behavior enabled by technology that allows people to stay connected without visiting in person. Walking trips were predominantly associated with "Home" as either the origin or destination. For cycling, the combination of "Home" and "Work or school" accounted for the majority of trips.

Walking trip durations to "Restaurants" and "Outdoors" increased from 5 minutes in 2005 to 10 minutes in 2022. Travel to "Places of worship" also rose from 10 minutes in 2005 to 20 minutes in 2022, tying with "Cultural venues" for the highest typical walking travel time. Walking times to "Home" and "Work or school" increased to 15 minutes in 2022, following three GSS cycles where they remained stable at 10 minutes. For cycling, 2015 marked the beginning of a trend toward longer travel times across nearly all destinations.

The share of the population with at least one recorded active trip ranged from a low of 6.93% in 1998 to a peak of 15.06% in 2010. In the most recent GSS survey (2022), participation dropped to 9.45%. Walking dominated active trips, representing over 90% of all episodes. About 84% of individuals who walked and 90% who cycled made only one trip. The maximum number of trips recorded by a single individual was 10 (in 1992, 2005, and 2010) for walking and 4 (in 2005) for cycling. Among the general population, the average number of active trips per person was near zero, while among those active, the average was two trips. An increasing trend in active episodes per person was observed for both walking and cycling.

Since 2010, the active population has declined for both genders, with a steeper decrease among Women+. This reversed a long-standing pattern in which Women+ had higher AT participation than Men+. In 2022, Men+ showed higher prevalence than Women+ regardless of mode, with 10.05% for Men+ and 8.84% for Women+. For cycling, Men+ increased their average trip duration from 19 minutes in 2010 to 33 minutes in 2022, while Women+ increased from 15 to 22 minutes. Since 2015, Women+ have reported longer walking durations than Men+ (19 vs. 17 minutes in 2022). Despite Men+ historically having slightly longer durations across modes, in 2022 the average durations were nearly equal: 19 minutes and 21 seconds for Men+ and 19 minutes and 11 seconds for Women+. Historically, Men+ recorded more active episodes than Women+, but in 2022 this trend reversed: Men+ averaged 2.07 episodes, while Women+ averaged 2.11. This change was driven by a decrease in walking episodes among Men+ (from 2.16 in 2015 to 2.07 in 2022) and an increase among Women+ (from 1.92 to 2.11 in the same period). In summary, Women+ made more active trips, while Men+ traveled longer distances and had higher overall participation in AT.

Regarding age cohorts, the youngest group (1524 years) remained the most active, with a prevalence of 21.47% in 2022. This was the only group to show increased participation over the past decade, up from 17.91% in 2015. Generally, AT prevalence decreases with age. However, in both 2005 and 2022, the oldest group (75 years and older) reported the third-highest AT prevalence (7.02%) and showed a steady increase in active episodes since 2010. Overall, all age groups improved compared to 1992, especially for walking. For cycling, a marked increase in duration emerged after 2010.

The study underscores the importance of applying destination-specific impedance functions when measuring cost decay effects in accessibility analyses. To this end, we fitted 83 impedance functions for AT trips over a 30-year period, considering destination types and transportation modes. The results indicate that none of the fitted functions followed an exponential distribution, suggesting that commonly used functions in AT accessibility studies may not adequately capture actual behaviorespecially for very short trips (under 3 minutes), which tend to be overrepresented in these models. Destinations with many episodes were best modeled using gamma functions, followed by lognormal and normal distributions. In contrast, destinations with fewer than six episodes were best represented by uniform distributions.

Given similarities in urbanization processes between Canada, the United States, Australia, and West Europe, these findings may also be applicable to metropolitan areas in those regions. Finally, this study contributes to the ongoing discussion on AT, emphasizing its importance in promoting sustainable transportation planning.

# References {#references .unnumbered}
